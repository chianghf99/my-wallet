<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    <title>å¡ç‰‡ç®¡å®¶ Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --input-bg: #f8f9fa;
            --text-color: #2d3748;
            --text-muted: #6c757d;
            --border-color: rgba(0,0,0,0.05);
            --shadow-color: rgba(0,0,0,0.05);
            --sidebar-bg: #ffffff;
        }

        /* ğŸŒ™ æ·±è‰²æ¨¡å¼è®Šæ•¸ */
        [data-theme="dark"] {
            --bg-color: #111827;       /* æ¥µæ·±è—é»‘ */
            --card-bg: #1f2937;        /* æ·±ç°è— */
            --input-bg: #374151;       /* æ·ºç° */
            --text-color: #f9fafb;     /* äº®ç™½ */
            --text-muted: #9ca3af;     /* æ·ºç° */
            --border-color: #374151;
            --shadow-color: rgba(0,0,0,0.3);
            --sidebar-bg: #1f2937;
        }

        body { background-color: var(--bg-color); color: var(--text-color); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif; padding-bottom: 90px; user-select: none; -webkit-user-select: none; transition: background-color 0.3s, color 0.3s; }
        
        /* å¼·åˆ¶è¦†è“‹ Bootstrap */
        [data-theme="dark"] .bg-light { background-color: var(--input-bg) !important; }
        [data-theme="dark"] .bg-white { background-color: var(--card-bg) !important; }
        [data-theme="dark"] .text-dark { color: var(--text-color) !important; }
        [data-theme="dark"] .text-secondary { color: var(--text-muted) !important; }
        [data-theme="dark"] .text-muted { color: var(--text-muted) !important; }
        [data-theme="dark"] .border { border-color: var(--border-color) !important; }
        
        .card, .modal-content, .bill-item {
            background-color: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 6px var(--shadow-color);
            transition: background-color 0.3s, border-color 0.3s;
        }
        
        .header-card {
            background: var(--primary-gradient); color: white;
            border-radius: 0 0 30px 30px;
            padding: 60px 20px 30px 20px;
            box-shadow: 0 4px 20px rgba(118, 75, 162, 0.4);
            margin-bottom: 20px;
            position: relative;
        }

        .bill-item { border-radius: 16px; margin-bottom: 12px; padding: 15px; }
        .bill-item:active { transform: scale(0.98); }
        .bill-icon { width: 45px; height: 45px; border-radius: 12px; background: var(--input-bg); color: #667eea; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; margin-right: 15px; }
        
        .form-control, .form-select { background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color); }
        .form-control:focus, .form-select:focus { background-color: var(--input-bg); color: var(--text-color); border-color: #667eea; box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25); }
        .form-control::placeholder { color: var(--text-muted); opacity: 0.7; }
        
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--card-bg); 
            border-top: 1px solid var(--border-color); padding: 12px 0;
            display: flex; justify-content: space-around; z-index: 1000;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
            transition: background-color 0.3s;
        }
        .nav-btn { text-align: center; color: var(--text-muted); font-size: 0.75rem; background: none; border: none; flex: 1; }
        .nav-btn.active { color: #764ba2; font-weight: 600; }
        .nav-btn i { font-size: 1.4rem; display: block; margin-bottom: 4px; }

        .sidebar { display: none; }
        @media (min-width: 992px) {
            body { padding-bottom: 0; padding-left: 260px; }
            .bottom-nav { display: none; }
            .sidebar {
                display: flex; flex-direction: column;
                position: fixed; top: 0; left: 0; width: 260px; height: 100vh;
                background: var(--sidebar-bg); border-right: 1px solid var(--border-color); z-index: 1000;
                padding: 30px 20px; transition: background-color 0.3s;
            }
            .sidebar-title { font-size: 1.5rem; font-weight: 800; color: var(--text-color); margin-bottom: 40px; padding-left: 10px; display: flex; align-items: center; cursor: pointer; }
            .sidebar-title i { color: #667eea; margin-right: 10px; }
            .side-btn {
                text-align: left; padding: 15px 20px; margin-bottom: 8px;
                border-radius: 12px; color: var(--text-muted); font-size: 1rem; font-weight: 500;
                background: none; border: none; transition: 0.2s; display: flex; align-items: center;
            }
            .side-btn:hover { background: rgba(102, 126, 234, 0.1); color: #667eea; }
            .side-btn.active { background: rgba(102, 126, 234, 0.1); color: #667eea; font-weight: 600; }
            .container { max-width: 1000px !important; padding-top: 30px; }
            .header-card { border-radius: 20px; margin-top: 0; padding: 40px; display: flex; align-items: center; justify-content: space-between; text-align: left; }
            .header-card .text-center { text-align: left !important; }
            .header-card .d-flex.justify-content-center { justify-content: flex-end !important; }
        }

        .version-link { color: var(--text-muted); font-size: 0.8rem; padding: 10px; cursor: pointer; transition: 0.2s; text-decoration: none; display: inline-block; }
        .version-link:hover { color: #667eea; }
        .changelog-item { position: relative; padding-left: 20px; margin-bottom: 15px; border-left: 2px solid var(--border-color); }
        .changelog-date { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 2px; }
        .changelog-ver { font-weight: bold; color: var(--text-color); font-size: 0.95rem; }
        .changelog-desc { font-size: 0.9rem; color: var(--text-muted); line-height: 1.5; }

        .badge-pill { padding: 5px 10px; border-radius: 20px; font-weight: normal; font-size: 0.75rem; }
        .bg-urgent { background: rgba(220, 38, 38, 0.15); color: #ef4444; }
        .bg-soon { background: rgba(217, 119, 6, 0.15); color: #f59e0b; }
        .bg-normal { background: rgba(79, 70, 229, 0.15); color: #6366f1; }
        
        .page-section { display: none; animation: fadeIn 0.3s; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        #pinOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 99999; display: none; flex-direction: column; justify-content: center; align-items: center; color: var(--text-color); }
        .key-btn { width: 70px; height: 70px; border-radius: 35px; background: var(--input-bg); border: 1px solid var(--border-color); font-size: 1.5rem; font-weight: 500; color: var(--text-color); display: flex; align-items: center; justify-content: center; margin: 0 auto; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .key-btn:active { background: var(--border-color); }
        .pin-dots { display: flex; gap: 15px; margin-bottom: 40px; }
        .dot { width: 14px; height: 14px; border-radius: 50%; background: var(--input-bg); border: 1px solid var(--border-color); transition: 0.2s; }
        .dot.active { background: #764ba2; border-color: #764ba2; transform: scale(1.2); }
        .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; width: 280px; }
        
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 9998; display: none; flex-direction: column; justify-content: center; align-items: center; color: white; }
    </style>
</head>
<body>

<div id="pinOverlay">
    <div class="mb-5 text-center">
        <div class="mb-3"><i class="fas fa-shield-alt fa-3x text-primary" style="background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i></div>
        <h5 class="fw-bold">æ­¡è¿å›ä¾†</h5>
        <p class="small opacity-75">è«‹è¼¸å…¥ 6 ä½æ•¸å®‰å…¨å¯†ç¢¼</p>
    </div>
    <div class="pin-dots"><div class="dot" id="d1"></div><div class="dot" id="d2"></div><div class="dot" id="d3"></div><div class="dot" id="d4"></div><div class="dot" id="d5"></div><div class="dot" id="d6"></div></div>
    <div class="keypad">
        <button class="key-btn" onclick="pressKey(1)">1</button><button class="key-btn" onclick="pressKey(2)">2</button><button class="key-btn" onclick="pressKey(3)">3</button>
        <button class="key-btn" onclick="pressKey(4)">4</button><button class="key-btn" onclick="pressKey(5)">5</button><button class="key-btn" onclick="pressKey(6)">6</button>
        <button class="key-btn" onclick="pressKey(7)">7</button><button class="key-btn" onclick="pressKey(8)">8</button><button class="key-btn" onclick="pressKey(9)">9</button>
        <button class="key-btn opacity-75" style="font-size: 1rem;" onclick="pressKey('clear')">æ¸…é™¤</button><button class="key-btn" onclick="pressKey(0)">0</button><button class="key-btn text-danger" onclick="pressKey('del')"><i class="fas fa-backspace"></i></button>
    </div>
</div>

<div id="loadingOverlay"><div class="spinner-border text-light" role="status"></div><div class="mt-3 fw-bold small">è³‡æ–™åŒæ­¥ä¸­...</div></div>

<div class="sidebar">
    <div class="sidebar-title" onclick="goToHome()"><i class="fas fa-wallet"></i> å¡ç‰‡ç®¡å®¶ Pro</div>
    <button class="side-btn active" onclick="switchPage('dashboard')"><i class="fas fa-home"></i> å¾…ç¹³å¸³å–®</button>
    <button class="side-btn" onclick="switchPage('history')"><i class="fas fa-history"></i> æ­·å²ç´€éŒ„</button>
    <button class="side-btn" onclick="switchPage('analysis')"><i class="fas fa-chart-pie"></i> çµ±è¨ˆåˆ†æ</button>
    <button class="side-btn" onclick="switchPage('settings')"><i class="fas fa-cog"></i> è¨­å®š</button>
    <div style="margin-top: auto;">
        <div class="version-link" onclick="showVersionModal()">
            <i class="fas fa-info-circle me-1"></i> ç‰ˆæœ¬ v3.4
        </div>
    </div>
</div>

<div id="page-dashboard" class="page-section active">
    <div class="header-card">
        <div class="w-100">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="badge bg-white bg-opacity-25 fw-normal rounded-pill px-3"><i class="fas fa-cloud me-1"></i> <span id="syncStatus">æœªåŒæ­¥</span></span>
                <div class="d-flex gap-3">
                    <button class="btn btn-sm text-white p-0" onclick="togglePrivacy()"><i class="fas fa-eye-slash" id="privacyIcon" style="font-size: 1.2rem;"></i></button>
                    <button class="btn btn-sm text-white p-0" onclick="goToHome()" title="å›é¦–é "><i class="fas fa-home" style="font-size: 1.2rem;"></i></button>
                </div>
            </div>
            
            <div class="text-center mt-3">
                <small class="opacity-75 text-uppercase ls-1">æœ¬æœˆå¾…ç¹³ç¸½é¡</small>
                <h1 class="display-3 fw-bold mb-0 mt-1" id="displayTotal">$0</h1>
            </div>
        </div>
        
        <div class="d-flex justify-content-center gap-3 mt-4 computer-actions">
            <button class="btn btn-light rounded-circle shadow-sm" style="width: 50px; height: 50px;" onclick="syncData('download')" title="åŒæ­¥"><i class="fas fa-sync-alt text-primary"></i></button>
            <button class="btn btn-light rounded-circle shadow-sm" style="width: 50px; height: 50px;" onclick="syncData('upload')" title="å­˜æª”"><i class="fas fa-cloud-upload-alt text-primary"></i></button>
            <button class="btn btn-light rounded-circle shadow-sm" style="width: 50px; height: 50px;" onclick="exportToExcel()" title="åŒ¯å‡º"><i class="fas fa-file-csv text-success"></i></button>
        </div>
    </div>

    <div class="container px-3">
        <div id="statementAlerts"></div>
        <div class="d-flex justify-content-between align-items-center mb-3 px-1">
            <h6 class="fw-bold text-secondary mb-0">å¾…ç¹³å¸³å–®</h6>
            <button class="btn btn-sm btn-light text-primary rounded-pill px-3 fw-bold shadow-sm" onclick="showAddModal()"><i class="fas fa-plus small me-1"></i> æ–°å¢</button>
        </div>
        <div class="row">
            <div class="col-12">
                <div id="unpaidList"></div>
                <div id="emptyMsg" class="text-center py-5 text-muted" style="display:none;">
                    <div class="mb-3"><i class="fas fa-check-circle fa-3x text-success opacity-25"></i></div>
                    <p>å¤ªæ£’äº†ï¼ç›®å‰æ²’æœ‰å¾…ç¹³å¸³å–®</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="page-history" class="page-section">
    <div class="container px-3 pt-4">
        <h5 class="fw-bold mb-4 px-1">ç¹³æ¬¾æ­·å²ç´€éŒ„</h5>
        <div class="row g-2 mb-4">
            <div class="col-8">
                <input type="text" id="historySearch" class="form-control rounded-pill" placeholder="ğŸ” æœå°‹éŠ€è¡Œåç¨±..." onkeyup="renderHistory()">
            </div>
            <div class="col-4">
                <select id="historyYearMonth" class="form-select rounded-pill" onchange="renderHistory()">
                    <option value="all">å…¨éƒ¨</option>
                </select>
            </div>
        </div>
        <div id="paidList"></div>
        <div id="historyEmptyMsg" class="text-center py-5 text-muted" style="display:none;">
            <p>æŸ¥ç„¡ç¬¦åˆçš„ç´€éŒ„</p>
        </div>
    </div>
</div>

<div id="page-analysis" class="page-section">
    <div class="container px-3 pt-4">
        <h5 class="fw-bold mb-3 px-1">æ¶ˆè²»åˆ†æ</h5>
        
        <div class="card border-0 shadow-sm rounded-4 mb-4">
            <div class="card-body p-3">
                <div class="row g-2 align-items-center">
                    <div class="col-5">
                        <label class="small text-muted ms-1">é–‹å§‹æ—¥æœŸ</label>
                        <input type="date" id="analysisStart" class="form-control form-control-sm rounded-pill border-0 bg-light">
                    </div>
                    <div class="col-5">
                        <label class="small text-muted ms-1">çµæŸæ—¥æœŸ</label>
                        <input type="date" id="analysisEnd" class="form-control form-control-sm rounded-pill border-0 bg-light">
                    </div>
                    <div class="col-2 text-end">
                        <label class="small text-muted opacity-0">.</label>
                        <button onclick="updateCharts()" class="btn btn-sm btn-primary w-100 rounded-pill"><i class="fas fa-search"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-md-4">
                <div class="card border-0 shadow-sm rounded-4 h-100">
                    <div class="card-body text-center py-5 d-flex flex-column justify-content-center">
                        <small class="text-muted text-uppercase mb-2">å€é–“ç´¯è¨ˆæ¶ˆè²»</small>
                        <h2 class="fw-bold text-primary display-5" id="yearlyTotal">$0</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card border-0 shadow-sm rounded-4 h-100">
                    <div class="card-body">
                        <h6 class="fw-bold mb-3 small text-muted">æ”¯å‡ºè¶¨å‹¢</h6>
                        <div style="height: 300px;"><canvas id="monthChart"></canvas></div>
                    </div>
                </div>
            </div>
            <div class="col-12">
                <div class="card border-0 shadow-sm rounded-4">
                    <div class="card-body">
                        <h6 class="fw-bold mb-3 small text-muted">å„éŠ€è¡Œä½”æ¯”</h6>
                        <div style="height: 300px; position: relative;"><canvas id="cardChart"></canvas></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="page-settings" class="page-section">
    <div class="container px-3 pt-4">
        <h5 class="fw-bold mb-4 px-1">è¨­å®š</h5>
        <div class="row g-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm rounded-4">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="fw-bold mb-1"><i class="fas fa-moon text-secondary me-2"></i>æ·±è‰²æ¨¡å¼</h6>
                            <small class="text-muted">åˆ‡æ›è‡³æš—è‰²ä¸»é¡Œ</small>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="darkModeSwitch" onchange="toggleDarkMode()">
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card border-0 shadow-sm rounded-4 h-100">
                    <div class="card-body">
                        <h6 class="fw-bold mb-3"><i class="fas fa-lock text-warning me-2"></i>å®‰å…¨é–</h6>
                        <div class="input-group mb-2">
                            <input type="tel" class="form-control" id="newAppPin" placeholder="è¨­å®š 6 ä½æ•¸å¯†ç¢¼" maxlength="6">
                            <button class="btn btn-dark" onclick="setAppPin()">è¨­å®š</button>
                        </div>
                        <button class="btn btn-sm text-danger p-0" onclick="clearAppPin()">æ¸…é™¤å¯†ç¢¼</button>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-0 shadow-sm rounded-4 h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="fw-bold mb-0"><i class="fas fa-cloud text-primary me-2"></i>é›²ç«¯åŒæ­¥</h6>
                            <button class="btn btn-sm btn-outline-info rounded-pill px-3" onclick="showHelpModal()">
                                <i class="fas fa-question-circle me-1"></i> é‡‘é‘°åœ¨å“ª?
                            </button>
                        </div>
                        <input type="text" class="form-control bg-light border-0 mb-2" id="inputBinId" placeholder="Bin ID">
                        <input type="password" class="form-control bg-light border-0 mb-3" id="inputApiKey" placeholder="API Key">
                        <button class="btn btn-primary w-100 rounded-pill" onclick="saveKeys()">å„²å­˜é‡‘é‘°</button>
                    </div>
                </div>
            </div>
            <div class="col-12">
                <div class="card border-0 shadow-sm rounded-4">
                    <div class="card-body">
                        <h6 class="fw-bold mb-3"><i class="fas fa-calendar-alt text-success me-2"></i>å‡ºå¸³æ—¥æé†’</h6>
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="newCardName" placeholder="éŠ€è¡Œ (å¦‚: ç‰å±±)">
                            <input type="number" class="form-control" id="newCardDay" placeholder="æ—¥" style="max-width: 70px;">
                            <button class="btn btn-outline-primary" onclick="addCardSetting()"><i class="fas fa-plus"></i></button>
                        </div>
                        <div id="cardSettingsList" class="row g-2"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="text-center mt-4">
            <div class="version-link text-muted" onclick="showVersionModal()">
                <i class="fas fa-info-circle me-1"></i> å¡ç‰‡ç®¡å®¶ Pro v3.4
            </div>
        </div>
    </div>
</div>

<div class="bottom-nav">
    <button class="nav-btn active" onclick="switchPage('dashboard')"><i class="fas fa-wallet"></i> å¾…ç¹³</button>
    <button class="nav-btn" onclick="switchPage('history')"><i class="fas fa-history"></i> æ­·å²</button>
    <button class="nav-btn" onclick="switchPage('analysis')"><i class="fas fa-chart-pie"></i> åˆ†æ</button>
    <button class="nav-btn" onclick="switchPage('settings')"><i class="fas fa-cog"></i> è¨­å®š</button>
</div>

<div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 rounded-4 shadow">
            <div class="modal-header border-0"><h5 class="modal-title fw-bold">è¨˜ä¸€ç­†</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <form id="addForm">
                    <input type="text" class="form-control form-control-lg mb-2" id="addName" placeholder="å¡ç‰‡åç¨±" required>
                    <input type="number" class="form-control form-control-lg mb-2" id="addAmount" placeholder="$ é‡‘é¡" required>
                    <input type="date" class="form-control form-control-lg mb-3" id="addDate" required>
                    <button type="submit" class="btn btn-primary w-100 btn-lg rounded-pill">ç¢ºå®šæ–°å¢</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="versionModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content border-0 rounded-4 shadow">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold"><i class="fas fa-history text-primary me-2"></i>æ›´æ–°æ—¥èªŒ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body rounded-bottom-4" style="max-height: 400px; overflow-y: auto;">
                <div class="changelog-item">
                    <div class="changelog-date">2025/12/17</div>
                    <div class="changelog-ver">v3.4</div>
                    <div class="changelog-desc">
                        â€¢ æ–°å¢çµ±è¨ˆåˆ†ææ—¥æœŸç¯©é¸ (å€é–“æŸ¥è©¢)<br>
                        â€¢ å„ªåŒ–åœ–è¡¨é¡¯ç¤ºé‚è¼¯<br>
                        â€¢ åŒ…å«æ‰€æœ‰ v3.3 çš„å„ªåŒ–åŠŸèƒ½
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="helpModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 rounded-4 shadow">
            <div class="modal-header border-0"><h5 class="modal-title fw-bold">â˜ï¸ é›²ç«¯é‡‘é‘°èªªæ˜</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div class="mb-4">
                    <h6 class="fw-bold text-success mb-2">ğŸ’¡ æ–¹æ³•ä¸€ï¼šçœ‹é›»è…¦ (æ¨è–¦)</h6>
                    <p class="small opacity-75 mb-0">é€™æ˜¯æœ€å¿«çš„æ–¹æ³•ï¼å› ç‚ºæ‚¨çš„é›»è…¦æ©Ÿå™¨äººå·²ç¶“è¨­å®šå¥½äº†ï¼Œå…©é‚Šå¿…é ˆç”¨åŒä¸€çµ„é‡‘é‘°æ‰èƒ½åŒæ­¥ã€‚</p>
                    <div class="bg-light p-3 rounded-3 mt-2 border">
                        <ol class="small mb-0 ps-3">
                            <li>æ‰“é–‹é›»è…¦ä¸Šçš„ <code>BillBot</code> è³‡æ–™å¤¾</li>
                            <li>æ‰¾åˆ° <code>config.json</code> æª”æ¡ˆ</li>
                            <li>ç”¨è¨˜äº‹æœ¬æ‰“é–‹å®ƒ</li>
                            <li>è¤‡è£½è£¡é¢çš„ <code>bin_id</code> å’Œ <code>api_key</code></li>
                        </ol>
                    </div>
                </div>
                <div>
                    <h6 class="fw-bold text-secondary mb-2">ğŸ”Œ æ–¹æ³•äºŒï¼šé‡æ–°ç”³è«‹</h6>
                    <p class="small opacity-75">å¦‚æœæ‚¨æ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼Œæˆ–æƒ³å»ºç«‹å…¨æ–°çš„è³‡æ–™åº«ã€‚</p>
                    <a href="https://jsonbin.io/login" target="_blank" class="btn btn-outline-primary w-100 btn-sm">å‰å¾€ JSONBin å®˜ç¶²</a>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let data = { bills: [], cards: [] };
    let binId = localStorage.getItem('jsonbin_bin_id') || '';
    let apiKey = localStorage.getItem('jsonbin_api_key') || '';
    let isPrivacyOn = false;
    let pinBuffer = "";
    const HOME_URL = "https://chianghf99.github.io/my-wallet/";

    function goToHome() { window.location.href = HOME_URL; }
    function checkLock() { if(localStorage.getItem('app_pin')) { document.getElementById('pinOverlay').style.display='flex'; pinBuffer=""; updateDots(); } }
    function pressKey(key) {
        if(key === 'clear') { pinBuffer = ""; } else if(key === 'del') { pinBuffer = pinBuffer.slice(0, -1); } else if(pinBuffer.length < 6) { pinBuffer += key; }
        updateDots();
        if(pinBuffer.length === 6) {
            if(pinBuffer === localStorage.getItem('app_pin')) setTimeout(() => { document.getElementById('pinOverlay').style.display='none'; }, 100);
            else { navigator.vibrate?.(200); setTimeout(() => { alert('å¯†ç¢¼éŒ¯èª¤'); pinBuffer = ""; updateDots(); }, 100); }
        }
    }
    function updateDots() { for(let i=1; i<=6; i++) document.getElementById('d'+i).classList.toggle('active', i<=pinBuffer.length); }
    function setAppPin() { const v = document.getElementById('newAppPin').value; if(v.length === 6 && !isNaN(v)) { localStorage.setItem('app_pin', v); alert('âœ… å¯†ç¢¼å·²è¨­å®š'); document.getElementById('newAppPin').value=''; } else alert('è«‹è¼¸å…¥ 6 ä½æ•¸å­—'); }
    function clearAppPin() { if(confirm('ç¢ºå®šç§»é™¤å¯†ç¢¼é–ï¼Ÿ')) { localStorage.removeItem('app_pin'); alert('å·²ç§»é™¤'); } }

    const addModal = new bootstrap.Modal(document.getElementById('addModal'));
    const versionModal = new bootstrap.Modal(document.getElementById('versionModal'));
    const helpModal = new bootstrap.Modal(document.getElementById('helpModal'));
    const loadingOverlay = document.getElementById('loadingOverlay');
    
    checkLock(); 
    loadLocal();
    initDarkMode();
    
    setTimeout(autoSyncCheck, 1000);

    document.getElementById('inputBinId').value = binId;
    document.getElementById('inputApiKey').value = apiKey;
    document.getElementById('addDate').value = new Date().toISOString().split('T')[0];
    
    // åˆå§‹åŒ–æ—¥æœŸç¯©é¸å™¨é è¨­å€¼ (ä»Šå¹´1/1 - ä»Šå¤©)
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), 0, 1);
    document.getElementById('analysisStart').value = firstDay.toISOString().split('T')[0];
    document.getElementById('analysisEnd').value = today.toISOString().split('T')[0];

    function showHelpModal() { helpModal.show(); }

    function autoSyncCheck() {
        const lastSyncStr = localStorage.getItem('last_sync_timestamp');
        const now = Date.now();
        const COOLDOWN = 30 * 60 * 1000; 
        if (!binId || !apiKey) return;
        if (!lastSyncStr || (now - parseInt(lastSyncStr) > COOLDOWN)) {
            console.log("â³ åŸ·è¡Œæ™ºæ…§è‡ªå‹•åŒæ­¥...");
            syncData('download', true);
        } else {
            console.log("âœ… è³‡æ–™å°šæ–°ï¼Œç•¥éåŒæ­¥");
        }
    }

    function initDarkMode() {
        if (localStorage.getItem('theme') === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
            document.getElementById('darkModeSwitch').checked = true;
        }
    }
    function toggleDarkMode() {
        if (document.getElementById('darkModeSwitch').checked) {
            document.body.setAttribute('data-theme', 'dark');
            localStorage.setItem('theme', 'dark');
        } else {
            document.body.removeAttribute('data-theme');
            localStorage.setItem('theme', 'light');
        }
    }

    function showVersionModal() { versionModal.show(); }
    function updateSyncStatus() { const t = localStorage.getItem('last_sync_time'); document.getElementById('syncStatus').textContent = t ? t : 'æœªåŒæ­¥'; }
    function togglePrivacy() { isPrivacyOn = !isPrivacyOn; document.getElementById('privacyIcon').className = isPrivacyOn ? 'fas fa-eye' : 'fas fa-eye-slash'; renderTotal(); }

    function switchPage(p) {
        document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
        document.getElementById('page-'+p).classList.add('active');
        document.querySelectorAll('.nav-btn, .side-btn').forEach(el => el.classList.remove('active'));
        document.querySelectorAll(`[onclick="switchPage('${p}')"]`).forEach(el => el.classList.add('active'));
        if(p === 'analysis') updateCharts();
        if(p === 'history') { updateHistoryFilterOptions(); renderHistory(); }
        if(p === 'dashboard') window.scrollTo(0,0);
    }

    function updateHistoryFilterOptions() {
        const select = document.getElementById('historyYearMonth');
        const currentVal = select.value;
        const years = new Set();
        data.bills.forEach(b => { if(b.status === 'paid' || b.status === 'skipped') years.add(b.date.substring(0, 7)); });
        const sortedYears = Array.from(years).sort().reverse();
        let html = '<option value="all">å…¨éƒ¨æ™‚é–“</option>';
        sortedYears.forEach(ym => { html += `<option value="${ym}">${ym}</option>`; });
        select.innerHTML = html;
        select.value = currentVal;
    }

    function renderHistory() {
        const pList = document.getElementById('paidList'), emptyMsg = document.getElementById('historyEmptyMsg');
        const searchTerm = document.getElementById('historySearch').value.toLowerCase();
        const filterYM = document.getElementById('historyYearMonth').value;
        pList.innerHTML = '';
        const paids = data.bills.filter(b => (b.status === 'paid' || b.status === 'skipped')).sort((a,b) => new Date(b.date) - new Date(a.date));
        let hasData = false;
        paids.forEach(b => {
            if (searchTerm && !b.name.toLowerCase().includes(searchTerm)) return;
            if (filterYM !== 'all' && !b.date.startsWith(filterYM)) return;
            hasData = true;
            let statusBadge = b.status === 'skipped' ? '<span class="badge bg-secondary">ç•¥é</span>' : '';
            let textClass = b.status === 'skipped' ? 'text-muted text-decoration-line-through' : 'text-decoration-line-through';
            pList.innerHTML += `<div class="bill-item d-flex align-items-center justify-content-between opacity-75"><div class="d-flex align-items-center"><div class="fw-bold text-secondary ps-2">${b.name} ${statusBadge}</div><div class="small text-muted ms-2">${b.date}</div></div><div class="text-end"><div class="${textClass}">$${b.amount.toLocaleString()}</div><div onclick="deleteBill(${b.id})" class="text-danger small" style="cursor:pointer;">åˆªé™¤</div></div></div>`;
        });
        emptyMsg.style.display = hasData ? 'none' : 'block';
    }

    function render() {
        const uList = document.getElementById('unpaidList'), emptyMsg = document.getElementById('emptyMsg');
        uList.innerHTML = '';
        const unpaids = data.bills.filter(b => b.status === 'unpaid').sort((a,b) => new Date(a.date) - new Date(b.date));
        unpaids.forEach(b => {
            const d = Math.ceil((new Date(b.date) - new Date().setHours(0,0,0,0)) / 86400000);
            let badgeClass = d < 0 ? 'bg-urgent' : d <= 3 ? 'bg-soon' : 'bg-normal';
            let badgeText = d < 0 ? `éæœŸ ${Math.abs(d)} å¤©` : `å‰© ${d} å¤©`;
            uList.innerHTML += `<div class="bill-item d-flex align-items-center justify-content-between"><div class="d-flex align-items-center"><div class="bill-icon"><i class="${getBankIcon(b.name)}"></i></div><div><div class="fw-bold text-dark">${b.name}</div><div class="small text-secondary">${b.date.slice(5)} æˆªæ­¢</div></div></div><div class="text-end"><div class="fw-bold mb-1 text-dark" style="font-size: 1.1rem;">$${b.amount.toLocaleString()}</div><div class="badge-pill ${badgeClass} d-inline-block mb-1">${badgeText}</div><div onclick="markAsPaid(${b.id})" class="text-success small cursor-pointer"><i class="far fa-check-circle"></i> æ¨™è¨˜å·²ç¹³</div></div></div>`;
        });
        renderTotal(); emptyMsg.style.display = unpaids.length ? 'none' : 'block'; checkAlerts(); renderSettings(); updateSyncStatus(); renderHistory();
    }

    function getBankIcon(name) {
        if(name.includes('ç‰å±±')) return 'fas fa-mountain';
        if(name.includes('å¯Œé‚¦')) return 'fas fa-tree';
        if(name.includes('åœ‹æ³°')) return 'fas fa-leaf';
        if(name.includes('å°æ–°')) return 'fas fa-dog';
        if(name.includes('æ°¸è±')) return 'fas fa-coins';
        if(name.includes('å½°åŒ–') || name.includes('å½°éŠ€')) return 'fas fa-landmark';
        return 'fas fa-credit-card';
    }

    function renderTotal() { document.getElementById('displayTotal').textContent = !isPrivacyOn ? '$' + data.bills.filter(b => b.status === 'unpaid').reduce((s,b) => s + b.amount, 0).toLocaleString() : '$****'; }

    function checkAlerts() {
        const box = document.getElementById('statementAlerts'); box.innerHTML = '';
        const today = new Date().getDate();
        const now = new Date();
        data.cards.forEach(c => {
            if (today >= c.day) {
                const expectedStatementDate = new Date(now.getFullYear(), now.getMonth(), c.day);
                const hasNewBill = data.bills.some(b => b.name.includes(c.name) && new Date(b.date) > expectedStatementDate);
                if (!hasNewBill) {
                    box.innerHTML += `<div class="alert alert-warning border-0 shadow-sm rounded-3 mb-3 d-flex align-items-center justify-content-between"><div class="d-flex align-items-center"><i class="fas fa-bell me-3 fs-4 text-warning"></i><div><strong>${c.name}</strong> æ‡‰å·²å‡ºå¸³ (${c.day}è™Ÿ)<br><small>å°šæœªæ”¶åˆ°å¸³å–®</small></div></div><button class="btn btn-sm btn-outline-secondary" onclick="markAsSkipped('${c.name}')">ğŸ”• æœ¬æœŸç„¡å¸³å–®</button></div>`;
                }
            }
        });
    }

    function markAsSkipped(cardName) {
        if(!confirm(`ç¢ºèªæ¨™è¨˜ ${cardName} æœ¬æœŸç„¡å¸³å–®ï¼Ÿ`)) return;
        const d = new Date(); d.setDate(d.getDate() + 20);
        const newBill = { id: Date.now(), name: cardName + "(ç„¡å¸³å–®)", amount: 0, date: d.toISOString().split('T')[0], status: 'skipped' };
        data.bills.push(newBill); saveLocal(); render(); syncData('upload');
    }

    function markAsPaid(id) { if(confirm('å·²ç¹³æ¬¾ï¼Ÿ')) { data.bills.find(b=>b.id===id).status='paid'; saveLocal(); render(); } }
    
    function deleteBill(id) { 
        if(confirm('ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ')) { 
            data.bills = data.bills.filter(b => b.id !== id); 
            saveLocal(); 
            render(); 
            syncData('upload', true); 
        } 
    }

    function addCardSetting() { const n=document.getElementById('newCardName').value, d=document.getElementById('newCardDay').value; if(n&&d){ data.cards.push({name:n, day:parseInt(d)}); saveLocal(); render(); document.getElementById('newCardName').value=''; } }
    function removeCardSetting(i) { data.cards.splice(i,1); saveLocal(); render(); }
    function renderSettings() { const l=document.getElementById('cardSettingsList'); l.innerHTML=''; data.cards.forEach((c,i)=>l.innerHTML+=`<div class="col-md-6"><div class="p-3 border rounded-3 d-flex justify-content-between align-items-center bg-white"><span class="text-dark"><i class="fas fa-credit-card text-muted me-2"></i>${c.name} (${c.day}è™Ÿ)</span><button class="btn btn-sm text-danger" onclick="removeCardSetting(${i})"><i class="fas fa-times"></i></button></div></div>`); }
    function saveLocal() { localStorage.setItem('myCreditData', JSON.stringify(data)); }
    function loadLocal() { const s=localStorage.getItem('myCreditData'); if(s) { data=JSON.parse(s); if(Array.isArray(data)) data={bills:data,cards:[]}; } render(); }
    function saveKeys() { localStorage.setItem('jsonbin_bin_id', document.getElementById('inputBinId').value); localStorage.setItem('jsonbin_api_key', document.getElementById('inputApiKey').value); alert('âœ… é‡‘é‘°å·²å„²å­˜'); }
    
    async function syncData(m, silent = false) {
        if(!binId && !apiKey) { if(!silent) alert('è«‹å…ˆè¨­å®šé‡‘é‘°'); return; }
        if(!silent) loadingOverlay.style.display='flex';
        const statusText = document.getElementById('syncStatus');
        if(silent) statusText.textContent = 'ğŸ”„...';

        try {
            const url = `https://api.jsonbin.io/v3/b/${binId}`;
            if(m==='download') {
                const res = await fetch(url+'/latest', {headers:{'X-Master-Key':apiKey}}); if(!res.ok) throw new Error();
                const json = await res.json(); data = Array.isArray(json.record) ? {bills:json.record, cards:[]} : json.record;
                const now = new Date(); 
                localStorage.setItem('last_sync_time', `${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`);
                localStorage.setItem('last_sync_timestamp', Date.now()); 
                saveLocal(); 
                if(!silent) alert('âœ… åŒæ­¥å®Œæˆ');
            } else { 
                const res = await fetch(url, {method:'PUT', headers:{'Content-Type':'application/json','X-Master-Key':apiKey}, body:JSON.stringify(data)}); 
                if(!res.ok) throw new Error(); 
                if(!silent) alert('â˜ï¸ å·²å‚™ä»½'); 
            }
        } catch(e) { if(!silent) alert('åŒæ­¥å¤±æ•—'); console.error(e); } 
        finally { 
            loadingOverlay.style.display='none'; 
            render(); 
            if(silent) setTimeout(() => updateSyncStatus(), 1000);
        }
    }
    document.getElementById('addForm').addEventListener('submit', function(e){ e.preventDefault(); data.bills.push({id:Date.now(), name:document.getElementById('addName').value, amount:parseInt(document.getElementById('addAmount').value), date:document.getElementById('addDate').value, status:'unpaid'}); saveLocal(); render(); addModal.hide(); this.reset(); });
    function exportToExcel() { if(!data.bills.length)return alert('ç„¡è³‡æ–™'); const csv="å¡ç‰‡,é‡‘é¡,æ—¥æœŸ,ç‹€æ…‹\n"+data.bills.map(b=>`"${b.name}",${b.amount},${b.date},${b.status==='paid'?'å·²ç¹³':'æœªç¹³'}`).join('\n'); const l=document.createElement('a'); l.href=URL.createObjectURL(new Blob(["\ufeff"+csv],{type:'text/csv'})); l.download=`å¸³å–®.csv`; l.click(); }

    // âœ… v3.4 æ›´æ–°ï¼šå‹•æ…‹åˆ†æé‚è¼¯
    let cardChart, monthChart;
    function updateCharts() {
        const ctxCard = document.getElementById('cardChart').getContext('2d');
        const ctxMonth = document.getElementById('monthChart').getContext('2d');
        
        const startStr = document.getElementById('analysisStart').value;
        const endStr = document.getElementById('analysisEnd').value;

        // 1. ç¯©é¸è³‡æ–™ (ç¯„åœå…§ + éç•¥é)
        const targetBills = data.bills.filter(b => {
            return b.date >= startStr && b.date <= endStr && b.status !== 'skipped';
        });
        
        // 2. è¨ˆç®—ç¸½é¡
        const total = targetBills.reduce((sum, b) => sum + b.amount, 0);
        document.getElementById('yearlyTotal').textContent = '$' + total.toLocaleString();
        
        // 3. æº–å‚™åœ–è¡¨æ•¸æ“š
        const cardMap = {};
        const timeMap = {}; // ç”¨ä¾†å­˜ "YYYY-MM" çš„é‡‘é¡

        targetBills.forEach(b => {
            // åœ“é¤…åœ–ï¼šéŠ€è¡Œåˆ†é¡
            let name = b.name.substring(0, 2);
            cardMap[name] = (cardMap[name] || 0) + b.amount;
            
            // é•·æ¢åœ–ï¼šæœˆä»½è¶¨å‹¢
            const monthKey = b.date.substring(0, 7); // å– "2025-01"
            timeMap[monthKey] = (timeMap[monthKey] || 0) + b.amount;
        });

        // 4. ç¹ªè£½åœ“é¤…åœ–
        if(cardChart) cardChart.destroy();
        cardChart = new Chart(ctxCard, {
            type: 'doughnut',
            data: {
                labels: Object.keys(cardMap),
                datasets: [{
                    data: Object.values(cardMap),
                    backgroundColor: ['#667eea','#764ba2','#48bb78','#f6ad55','#f56565','#ed64a6'],
                    borderWidth: 0
                }]
            },
            options: {
                plugins: {
                    legend: {
                        position: 'right',
                        labels: { color: document.body.getAttribute('data-theme')==='dark'?'#f7fafc':'#666' }
                    }
                },
                maintainAspectRatio: false
            }
        });

        // 5. ç¹ªè£½é•·æ¢åœ– (å‹•æ…‹æ’åº)
        const sortedKeys = Object.keys(timeMap).sort(); // ç¢ºä¿æ—¥æœŸç”±å°åˆ°å¤§
        const monthLabels = sortedKeys; 
        const monthData = sortedKeys.map(k => timeMap[k]);

        if(monthChart) monthChart.destroy();
        monthChart = new Chart(ctxMonth, {
            type: 'bar',
            data: {
                labels: monthLabels,
                datasets: [{
                    label: 'æ”¯å‡º',
                    data: monthData,
                    backgroundColor: '#667eea',
                    borderRadius: 4
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: document.body.getAttribute('data-theme')==='dark'?'rgba(255,255,255,0.1)':'rgba(0,0,0,0.05)' },
                        ticks: { color: document.body.getAttribute('data-theme')==='dark'?'#a0aec0':'#666' }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: document.body.getAttribute('data-theme')==='dark'?'#a0aec0':'#666' }
                    }
                },
                plugins: { legend: { display: false } },
                maintainAspectRatio: false
            }
        });
    }
</script>
</body>
</html>
