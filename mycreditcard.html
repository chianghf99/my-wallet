<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    <title>å¡ç‰‡ç®¡å®¶ Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f4f6f9; font-family: -apple-system, "Microsoft JhengHei", sans-serif; padding-bottom: 80px; user-select: none; -webkit-user-select: none; }
        .card-custom { border: none; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .total-box { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 0 0 25px 25px; margin-top: -25px; padding-top: 50px !important; padding-bottom: 20px !important; }
        .status-paid { text-decoration: line-through; color: #999; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #eee; display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 1000; }
        .nav-item { text-align: center; color: #999; font-size: 0.8rem; cursor: pointer; flex: 1;}
        .nav-item.active { color: #667eea; font-weight: bold; }
        .nav-item i { font-size: 1.2rem; display: block; margin-bottom: 4px; }
        .page-section { display: none; }
        .page-section.active { display: block; }
        #pinOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f4f6f9; z-index: 10000; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .pin-dot { width: 12px; height: 12px; border-radius: 50%; background: #ddd; margin: 0 4px; display: inline-block; transition: 0.2s; }
        .pin-dot.filled { background: #667eea; transform: scale(1.2); }
        .btn-circle { border-radius: 50%; width: 40px; height: 40px; padding: 0; display: inline-flex; justify-content: center; align-items: center;}
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; }
    </style>
</head>
<body>

<div id="pinOverlay">
    <div class="text-center mb-4">
        <i class="fas fa-lock fa-3x text-secondary mb-3"></i>
        <h4 class="fw-bold text-secondary">è«‹è¼¸å…¥ 6 ä½æ•¸å¯†ç¢¼</h4>
    </div>
    <div class="mb-4">
        <span class="pin-dot" id="dot1"></span><span class="pin-dot" id="dot2"></span><span class="pin-dot" id="dot3"></span><span class="pin-dot" id="dot4"></span><span class="pin-dot" id="dot5"></span><span class="pin-dot" id="dot6"></span>
    </div>
    <input type="tel" id="pinInput" maxlength="6" style="opacity: 0; position: absolute; top: -1000px;">
    <button class="btn btn-outline-primary px-4 rounded-pill" onclick="focusPinInput()"><i class="fas fa-key"></i> è§£é–</button>
</div>

<div id="loadingOverlay"><div class="spinner-border text-primary" role="status"></div><div class="mt-3 fw-bold text-primary">åŒæ­¥ä¸­...</div></div>

<div id="page-dashboard" class="page-section active">
    <div class="card card-custom total-box mb-3 p-4 text-center shadow">
        <div class="d-flex justify-content-between align-items-start w-100 mb-2">
            <span class="opacity-50 small"><i class="fas fa-signal"></i> Proç‰ˆ</span>
            <button class="btn btn-sm btn-outline-light border-0" onclick="togglePrivacy()"><i class="fas fa-eye" id="privacyIcon"></i></button>
        </div>
        <h6 class="opacity-75 text-uppercase ls-1">æœ¬æœˆå¾…ç¹³ç¸½é¡</h6>
        <h1 class="display-3 fw-bold my-2" id="displayTotal">$****</h1>
        <div class="mt-3 d-flex justify-content-center gap-2">
            <button class="btn btn-light text-primary btn-sm px-3 shadow-sm" onclick="syncData('download')"><i class="fas fa-cloud-download-alt"></i> åŒæ­¥</button>
            <button class="btn btn-light text-primary btn-sm px-3 shadow-sm" onclick="syncData('upload')"><i class="fas fa-save"></i> å­˜æª”</button>
            <button class="btn btn-outline-light btn-sm px-3" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> åŒ¯å‡º</button>
        </div>
    </div>
    <div class="container" style="max-width: 800px;">
        <div id="statementAlerts"></div>
        <div class="d-flex justify-content-between align-items-center mb-2 px-2">
            <h6 class="fw-bold text-muted mb-0">å¾…ç¹³å¸³å–®</h6>
            <button class="btn btn-sm text-primary" onclick="showAddModal()"><i class="fas fa-plus"></i> æ‰‹å‹•æ–°å¢</button>
        </div>
        <div class="card card-custom mb-5">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0"><tbody id="unpaidList"></tbody></table>
                </div>
                <div id="emptyMsg" class="text-center py-5 text-muted" style="display:none;"><i class="fas fa-check-circle fa-3x mb-3 text-success opacity-50"></i><p>å¤ªæ£’äº†ï¼ç›®å‰æ²’æœ‰å¾…ç¹³å¸³å–®</p></div>
            </div>
        </div>
    </div>
</div>

<div id="page-history" class="page-section">
    <div class="container pt-4" style="max-width: 800px;">
        <h5 class="fw-bold mb-3 px-2"><i class="fas fa-history text-primary"></i> ç¹³æ¬¾æ­·å²</h5>
        <div class="card card-custom">
            <div class="card-body p-0">
                <table class="table table-hover align-middle mb-0"><tbody id="paidList"></tbody></table>
            </div>
        </div>
    </div>
</div>

<div id="page-analysis" class="page-section">
    <div class="container pt-4" style="max-width: 800px;">
        <h5 class="fw-bold mb-3 px-2"><i class="fas fa-chart-pie text-primary"></i> å¹´åº¦æ¶ˆè²»åˆ†æ</h5>
        
        <div class="card card-custom mb-3">
            <div class="card-body">
                <h6 class="fw-bold text-center mb-3">å„éŠ€è¡Œæ¶ˆè²»ä½”æ¯”</h6>
                <canvas id="cardChart"></canvas>
            </div>
        </div>

        <div class="card card-custom mb-4">
            <div class="card-body">
                <h6 class="fw-bold text-center mb-3">æ¯æœˆæ”¯å‡ºè¶¨å‹¢</h6>
                <canvas id="monthChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div id="page-settings" class="page-section">
    <div class="container pt-4" style="max-width: 800px;">
        <h5 class="fw-bold mb-3 px-2"><i class="fas fa-cog text-primary"></i> è¨­å®š</h5>
        <div class="card card-custom mb-4 border-warning border-2">
            <div class="card-body">
                <h6 class="fw-bold mb-3 text-warning"><i class="fas fa-lock"></i> App å¯†ç¢¼é–</h6>
                <div class="input-group mb-2">
                    <input type="tel" class="form-control" id="newAppPin" placeholder="è¼¸å…¥ 6 ä½æ•¸å¯†ç¢¼" maxlength="6">
                    <button class="btn btn-warning text-dark fw-bold" onclick="setAppPin()">è¨­å®š</button>
                </div>
                <button class="btn btn-sm btn-outline-danger mt-2 float-end" onclick="clearAppPin()">æ¸…é™¤</button>
            </div>
        </div>
        <div class="card card-custom mb-4">
            <div class="card-body">
                <h6 class="fw-bold mb-3">â˜ï¸ JSONBin é›²ç«¯åŒæ­¥</h6>
                <div class="mb-2"><input type="text" class="form-control bg-light" id="inputBinId" placeholder="Bin ID"></div>
                <div class="mb-3"><input type="password" class="form-control bg-light" id="inputApiKey" placeholder="API Key"></div>
                <button class="btn btn-primary w-100" onclick="saveKeys()">å„²å­˜é‡‘é‘°</button>
            </div>
        </div>
        <div class="card card-custom mb-4">
            <div class="card-body">
                <h6 class="fw-bold mb-3">ğŸ“… å‡ºå¸³æé†’</h6>
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="newCardName" placeholder="åç¨±">
                    <input type="number" class="form-control" id="newCardDay" placeholder="æ—¥" style="max-width: 80px;">
                    <button class="btn btn-outline-primary" onclick="addCardSetting()">æ–°å¢</button>
                </div>
                <ul class="list-group list-group-flush" id="cardSettingsList"></ul>
            </div>
        </div>
    </div>
</div>

<div class="bottom-nav">
    <div class="nav-item active" onclick="switchPage('dashboard')"><i class="fas fa-wallet"></i> å¾…ç¹³</div>
    <div class="nav-item" onclick="switchPage('history')"><i class="fas fa-history"></i> æ­·å²</div>
    <div class="nav-item" onclick="switchPage('analysis')"><i class="fas fa-chart-pie"></i> åˆ†æ</div>
    <div class="nav-item" onclick="switchPage('settings')"><i class="fas fa-sliders-h"></i> è¨­å®š</div>
</div>

<div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">æ–°å¢</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <form id="addForm">
                    <input type="text" class="form-control mb-2" id="addName" placeholder="å¡ç‰‡" required>
                    <input type="number" class="form-control mb-2" id="addAmount" placeholder="é‡‘é¡" required>
                    <input type="date" class="form-control mb-3" id="addDate" required>
                    <button type="submit" class="btn btn-primary w-100">ç¢ºå®š</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let data = { bills: [], cards: [] };
    let binId = localStorage.getItem('jsonbin_bin_id') || '';
    let apiKey = localStorage.getItem('jsonbin_api_key') || '';
    let isPrivacyOn = true;
    
    // PIN Lock
    const pinInput = document.getElementById('pinInput'), pinOverlay = document.getElementById('pinOverlay');
    function checkLock() { if(localStorage.getItem('app_pin')) { pinOverlay.style.display='flex'; pinInput.value=''; updateDots(0); focusPinInput(); } }
    function focusPinInput() { pinInput.focus(); }
    pinInput.addEventListener('input', function() {
        updateDots(this.value.length);
        if(this.value.length===6) {
            if(this.value===localStorage.getItem('app_pin')) pinOverlay.style.display='none';
            else { alert('éŒ¯èª¤'); this.value=''; updateDots(0); }
        }
    });
    function updateDots(c) { for(let i=1;i<=6;i++) document.getElementById('dot'+i).classList.toggle('filled', i<=c); }
    function setAppPin() { const v=document.getElementById('newAppPin').value; if(v.length===6 && !isNaN(v)) { localStorage.setItem('app_pin',v); alert('å·²è¨­å®š'); document.getElementById('newAppPin').value=''; } else alert('è«‹è¼¸å…¥6ç¢¼'); }
    function clearAppPin() { if(confirm('ç§»é™¤å¯†ç¢¼?')) { localStorage.removeItem('app_pin'); alert('å·²ç§»é™¤'); } }

    // Core
    const addModal = new bootstrap.Modal(document.getElementById('addModal')), loadingOverlay = document.getElementById('loadingOverlay');
    checkLock(); loadLocal();
    document.getElementById('inputBinId').value = binId; document.getElementById('inputApiKey').value = apiKey; document.getElementById('addDate').value = new Date().toISOString().split('T')[0];

    function togglePrivacy() {
        isPrivacyOn = !isPrivacyOn;
        document.getElementById('privacyIcon').className = isPrivacyOn ? 'fas fa-eye' : 'fas fa-eye-slash';
        document.getElementById('displayTotal').textContent = isPrivacyOn ? '$****' : '$' + data.bills.filter(b=>b.status!=='paid').reduce((s,b)=>s+b.amount,0).toLocaleString();
    }

    function switchPage(p) {
        document.querySelectorAll('.page-section').forEach(el=>el.classList.remove('active'));
        document.getElementById('page-'+p).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active'));
        event.currentTarget.classList.add('active');
        if(p==='analysis') updateCharts(); // åˆ‡æ›åˆ°åˆ†æé æ™‚æ›´æ–°åœ–è¡¨
    }

    function render() {
        const uList = document.getElementById('unpaidList'), pList = document.getElementById('paidList');
        uList.innerHTML = ''; pList.innerHTML = '';
        const unpaids = data.bills.filter(b=>b.status!=='paid').sort((a,b)=>new Date(a.date)-new Date(b.date));
        const paids = data.bills.filter(b=>b.status==='paid').sort((a,b)=>new Date(b.date)-new Date(a.date));

        unpaids.forEach(b => {
            const d = Math.ceil((new Date(b.date)-new Date().setHours(0,0,0,0))/86400000);
            const badge = d<0 ? '<span class="badge bg-danger">éæœŸ</span>' : d<=3 ? `<span class="badge bg-warning text-dark">å‰©${d}å¤©</span>` : `<span class="badge bg-light text-dark border">å‰©${d}å¤©</span>`;
            uList.innerHTML += `<tr><td class="ps-3 fw-bold">${b.name}</td><td>$${b.amount.toLocaleString()}</td><td><small>${b.date.slice(5)}</small><br>${badge}</td><td class="text-end pe-3"><button onclick="markAsPaid(${b.id})" class="btn btn-outline-success btn-sm btn-circle"><i class="fas fa-check"></i></button></td></tr>`;
        });
        paids.forEach(b => {
            pList.innerHTML += `<tr class="status-paid"><td class="ps-3">${b.name}</td><td>$${b.amount.toLocaleString()}</td><td>${b.date}</td><td class="text-end pe-3"><button onclick="deleteBill(${b.id})" class="btn btn-light text-danger btn-sm"><i class="fas fa-trash"></i></button></td></tr>`;
        });

        if(!isPrivacyOn) document.getElementById('displayTotal').textContent = '$'+unpaids.reduce((s,b)=>s+b.amount,0).toLocaleString();
        document.getElementById('emptyMsg').style.display = unpaids.length ? 'none' : 'block';
        checkAlerts(); renderSettings();
    }

    function checkAlerts() {
        const box = document.getElementById('statementAlerts'); box.innerHTML = '';
        const today = new Date().getDate();
        data.cards.forEach(c => {
            if(today >= c.day && !data.bills.some(b => b.name.includes(c.name) && b.status !== 'paid'))
                box.innerHTML += `<div class="alert alert-warning border-0 shadow-sm small"><i class="fas fa-bell me-2"></i><strong>${c.name}</strong> æ‡‰å·²å‡ºå¸³ (${c.day}è™Ÿ)</div>`;
        });
    }

    // Chart.js Logic
    let cardChart, monthChart;
    function updateCharts() {
        const ctxCard = document.getElementById('cardChart').getContext('2d');
        const ctxMonth = document.getElementById('monthChart').getContext('2d');
        
        // 1. æº–å‚™æ•¸æ“š: åªçµ±è¨ˆ "ä»Šå¹´" çš„è³‡æ–™ (åŒ…å«å·²ç¹³å’Œæœªç¹³)
        const currentYear = new Date().getFullYear();
        const yearBills = data.bills.filter(b => new Date(b.date).getFullYear() === currentYear);

        // å¡ç‰‡çµ±è¨ˆ
        const cardMap = {};
        yearBills.forEach(b => { 
            // ç°¡åŒ–å¡ç‰‡åç¨± (å–å‰å…©å€‹å­—ï¼Œå¦‚ "ç‰å±±")
            let name = b.name.substring(0, 2);
            cardMap[name] = (cardMap[name] || 0) + b.amount; 
        });
        
        // æœˆä»½çµ±è¨ˆ
        const monthMap = new Array(12).fill(0);
        yearBills.forEach(b => {
            const m = new Date(b.date).getMonth(); // 0-11
            monthMap[m] += b.amount;
        });

        // æ¸²æŸ“åœ“é¤…åœ–
        if(cardChart) cardChart.destroy();
        cardChart = new Chart(ctxCard, {
            type: 'doughnut',
            data: {
                labels: Object.keys(cardMap),
                datasets: [{ data: Object.values(cardMap), backgroundColor: ['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF','#FF9F40'] }]
            }
        });

        // æ¸²æŸ“é•·æ¢åœ–
        if(monthChart) monthChart.destroy();
        monthChart = new Chart(ctxMonth, {
            type: 'bar',
            data: {
                labels: ['1æœˆ','2æœˆ','3æœˆ','4æœˆ','5æœˆ','6æœˆ','7æœˆ','8æœˆ','9æœˆ','10æœˆ','11æœˆ','12æœˆ'],
                datasets: [{ label: 'æ¯æœˆæ”¯å‡º', data: monthMap, backgroundColor: '#667eea', borderRadius: 5 }]
            },
            options: { scales: { y: { beginAtZero: true } } }
        });
    }

    function markAsPaid(id) { if(confirm('å·²ç¹³æ¬¾?')) { data.bills.find(b=>b.id===id).status='paid'; saveLocal(); render(); } }
    function deleteBill(id) { if(confirm('åˆªé™¤?')) { data.bills=data.bills.filter(b=>b.id!==id); saveLocal(); render(); } }
    function addCardSetting() { const n=document.getElementById('newCardName').value, d=document.getElementById('newCardDay').value; if(n&&d){ data.cards.push({name:n, day:parseInt(d)}); saveLocal(); render(); document.getElementById('newCardName').value=''; } }
    function removeCardSetting(i) { data.cards.splice(i,1); saveLocal(); render(); }
    function renderSettings() { 
        const l=document.getElementById('cardSettingsList'); l.innerHTML=''; 
        data.cards.forEach((c,i)=>l.innerHTML+=`<li class="list-group-item d-flex justify-content-between"><span>${c.name} (${c.day}è™Ÿ)</span><button class="btn btn-sm text-danger" onclick="removeCardSetting(${i})"><i class="fas fa-times"></i></button></li>`); 
    }
    
    function saveLocal() { localStorage.setItem('myCreditData', JSON.stringify(data)); }
    function loadLocal() { const s=localStorage.getItem('myCreditData'); if(s) { data=JSON.parse(s); if(Array.isArray(data)) data={bills:data,cards:[]}; } render(); }
    function saveKeys() { localStorage.setItem('jsonbin_bin_id', document.getElementById('inputBinId').value); localStorage.setItem('jsonbin_api_key', document.getElementById('inputApiKey').value); alert('å·²å„²å­˜'); }
    async function syncData(m) {
        if(!binId && !apiKey) return alert('è«‹è¨­é‡‘é‘°');
        loadingOverlay.style.display='flex';
        try {
            const url = `https://api.jsonbin.io/v3/b/${binId}`;
            if(m==='download') {
                const res = await fetch(url+'/latest', {headers:{'X-Master-Key':apiKey}});
                if(!res.ok) throw new Error();
                const json = await res.json();
                data = Array.isArray(json.record) ? {bills:json.record, cards:[]} : json.record;
                saveLocal(); alert('å®Œæˆ');
            } else {
                const res = await fetch(url, {method:'PUT', headers:{'Content-Type':'application/json','X-Master-Key':apiKey}, body:JSON.stringify(data)});
                if(!res.ok) throw new Error(); alert('å·²å‚™ä»½');
            }
        } catch(e) { alert('éŒ¯èª¤'); } finally { loadingOverlay.style.display='none'; render(); }
    }
    
    document.getElementById('addForm').addEventListener('submit', function(e){ e.preventDefault(); data.bills.push({id:Date.now(), name:document.getElementById('addName').value, amount:parseInt(document.getElementById('addAmount').value), date:document.getElementById('addDate').value, status:'unpaid'}); saveLocal(); render(); addModal.hide(); this.reset(); });
    function exportToExcel() { if(!data.bills.length)return alert('ç„¡è³‡æ–™'); const csv="å¡ç‰‡,é‡‘é¡,æ—¥æœŸ,ç‹€æ…‹\n"+data.bills.map(b=>`"${b.name}",${b.amount},${b.date},${b.status==='paid'?'å·²ç¹³':'æœªç¹³'}`).join('\n'); const l=document.createElement('a'); l.href=URL.createObjectURL(new Blob(["\ufeff"+csv],{type:'text/csv'})); l.download=`å¸³å–®.csv`; l.click(); }
</script>
</body>
</html>
