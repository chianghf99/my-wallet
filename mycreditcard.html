import pdfplumber
import re
import os
import requests
import time
import logging
import sys
from datetime import datetime
from send2trash import send2trash

# ğŸ”‡ é—œé–‰ç´…è‰²è­¦å‘Š
logging.getLogger("pdfminer").setLevel(logging.ERROR)

# ========= ğŸŸ¢ è¨­å®šå€ =========
# è®€å– config.json
if getattr(sys, 'frozen', False):
    current_folder = os.path.dirname(sys.executable)
else:
    current_folder = os.path.dirname(os.path.abspath(__file__))

config_path = os.path.join(current_folder, "config.json")

def load_config():
    if not os.path.exists(config_path):
        print(f"âŒ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°è¨­å®šæª” {config_path}")
        print("è«‹ç¢ºèª config.json æ˜¯å¦å­˜åœ¨æ–¼åŒä¸€å€‹è³‡æ–™å¤¾ä¸­ã€‚")
        raise FileNotFoundError("æ‰¾ä¸åˆ° config.json")
    try:
        with open(config_path, 'r', encoding='utf-8') as f:
            return json.load(f)
    except Exception as e:
        print(f"âŒ è¨­å®šæª”è®€å–éŒ¯èª¤: {e}")
        raise e

try:
    config = load_config()
    BIN_ID = config.get("bin_id")
    API_KEY = config.get("api_key")
    PASSWORDS = config.get("passwords", {})
except:
    BIN_ID = None
    API_KEY = None
    PASSWORDS = {}

# ========================================

def move_to_trash(file_path):
    try:
        print(f"ğŸ—‘ï¸ æ­£åœ¨å°‡æª”æ¡ˆç§»è‡³åƒåœ¾æ¡¶...")
        if os.path.exists(file_path):
            send2trash(file_path)
            print("âœ… æª”æ¡ˆå·²ç§»é™¤ (åƒåœ¾æ¡¶)")
        else:
            print("âš ï¸ æª”æ¡ˆå¥½åƒå·²ç¶“ä¸è¦‹äº†ï¼Ÿ")
    except Exception as e:
        print(f"âš ï¸ ç„¡æ³•ç§»å‹•æª”æ¡ˆ (å¯èƒ½è¢«ä½”ç”¨): {e}")

def upload_to_cloud(card_name, amount, date, file_path):
    print(f"â˜ï¸ æº–å‚™ä¸Šå‚³ {card_name} (${amount})...")
    url = f"https://api.jsonbin.io/v3/b/{BIN_ID}"
    headers = {"Content-Type": "application/json", "X-Master-Key": API_KEY}

    try:
        res = requests.get(url + "/latest", headers=headers)
        if res.status_code != 200: 
            print(f"âŒ é€£ç·šå¤±æ•—: {res.status_code}")
            return
        
        full_record = res.json().get("record", {})
        if "bills" not in full_record: full_record["bills"] = []
        bills = full_record["bills"]
        
        for b in bills:
            if b.get("name") == card_name and str(b.get("amount")) == str(amount) and b.get("date") == date:
                print("âš ï¸ å·²ä¸Šå‚³éï¼Œè·³éã€‚")
                move_to_trash(file_path)
                return

        new_bill = {
            "id": int(time.time() * 1000),
            "name": card_name,
            "amount": amount,
            "date": date,
            "status": "unpaid"
        }
        bills.append(new_bill)
        
        res_put = requests.put(url, headers=headers, json=full_record)
        if res_put.status_code == 200:
            print(f"âœ… ä¸Šå‚³æˆåŠŸï¼")
            move_to_trash(file_path)
        else:
            print(f"âŒ ä¸Šå‚³å¤±æ•—ï¼š{res_put.text}")
            
    except Exception as e:
        print(f"é€£ç·šéŒ¯èª¤ï¼š{e}")

def clean_date(date_str):
    try:
        date_str = date_str.replace(" ", "").replace("\n", "")
        date_str = re.sub(r"[^\d/-]", "", date_str)
        parts = re.split(r'[/-]', date_str)
        if len(parts) == 3:
            year = int(parts[0])
            if year < 1911: year += 1911
            return f"{year}-{parts[1].zfill(2)}-{parts[2].zfill(2)}"
        return date_str
    except: return date_str

# --- éŠ€è¡Œé‚è¼¯å€ ---

def process_sinopac(pdf_path):
    filename = os.path.basename(pdf_path)
    print(f"ğŸ¤– å•Ÿå‹• [æ°¸è±] è§£ææ¨¡å¼... ({filename})")
    amount = -1
    due_date = "æœªçŸ¥æ—¥æœŸ"
    try:
        with pdfplumber.open(pdf_path, password=PASSWORDS.get("sinopac")) as pdf:
            text = pdf.pages[0].extract_text()
            date_match = re.search(r"æˆªæ­¢æ—¥\s*[:]?\s*(\d{4}/\d{2}/\d{2})", text)
            if date_match: due_date = clean_date(date_match.group(1))
            deduct_match = re.search(r"é å®šæ‰£æ¬¾é‡‘é¡\s*(\d{1,3}(?:,\d{3})*)", text)
            if deduct_match: amount = int(deduct_match.group(1).replace(",", ""))
            if amount == -1:
                amt_match = re.search(r"(?<!ä¸ŠæœŸ)æ‡‰ç¹³ç¸½é‡‘é¡\s*(\d{1,3}(?:,\d{3})*)", text)
                if amt_match: amount = int(amt_match.group(1).replace(",", ""))
            if amount == -1:
                tables = pdf.pages[0].extract_tables()
                for table in tables:
                    for row in table:
                        c_row = [str(c).replace("\n","").replace(" ","") for c in row if c]
                        if "è‡ºå¹£" in c_row and len(row) > 6:
                            try: amount = int(row[6].replace(",", "").strip())
                            except: continue
    except Exception as e:
        print(f"âŒ æ°¸è±éŒ¯èª¤ï¼š{e}")
        return
    if amount > 0: upload_to_cloud("æ°¸è±ä¿¡ç”¨å¡", amount, due_date, pdf_path)
    else: print("âŒ æ‰¾ä¸åˆ°æ°¸è±é‡‘é¡")

def process_fubon(pdf_path):
    filename = os.path.basename(pdf_path)
    print(f"ğŸ¤– å•Ÿå‹• [å¯Œé‚¦] è§£ææ¨¡å¼... ({filename})")
    amount = -1
    due_date = "æœªçŸ¥æ—¥æœŸ"
    try:
        with pdfplumber.open(pdf_path, password=PASSWORDS.get("fubon")) as pdf:
            text = pdf.pages[0].extract_text()
            date_match = re.search(r"(\d{2,3}/\d{2}/\d{2})", text)
            if date_match: due_date = clean_date(date_match.group(1))
            text_nospace = text.replace(" ", "") 
            amt_match = re.search(r"NT\$(\d{1,3}(?:,\d{3})*)", text_nospace)
            if amt_match: amount = int(amt_match.group(1).replace(",", ""))
    except Exception as e:
        print(f"âŒ å¯Œé‚¦éŒ¯èª¤ï¼š{e}")
        return
    if amount > 0: upload_to_cloud("å¯Œé‚¦ä¿¡ç”¨å¡", amount, due_date, pdf_path)
    else: print("âŒ æ‰¾ä¸åˆ°å¯Œé‚¦é‡‘é¡")

def process_taishin(pdf_path):
    filename = os.path.basename(pdf_path)
    print(f"ğŸ¤– å•Ÿå‹• [å°æ–°] è§£ææ¨¡å¼... ({filename})")
    amount = -1
    due_date = "æœªçŸ¥æ—¥æœŸ"
    try:
        with pdfplumber.open(pdf_path, password=PASSWORDS.get("taishin")) as pdf:
            text = pdf.pages[0].extract_text()
            date_match = re.search(r"æˆªæ­¢æ—¥\s*(\d{2,3}/\d{2}/\d{2})", text)
            if date_match: due_date = clean_date(date_match.group(1))
            if "æœ¬æœŸç´¯è¨ˆæ‡‰ç¹³é‡‘é¡" in text and "0" in text:
                 check_zero = re.search(r"æœ¬æœŸ.*?é‡‘é¡.*?0", text, re.DOTALL)
                 if check_zero: amount = 0
            if amount == -1:
                amt_match = re.search(r"æœ¬æœŸ.*?é‡‘é¡.*?(\d{1,3}(?:,\d{3})*)", text, re.DOTALL)
                if amt_match: amount = int(amt_match.group(1).replace(",", ""))
    except Exception as e:
        print(f"âŒ å°æ–°éŒ¯èª¤ï¼š{e}")
        return
    if amount > 0: upload_to_cloud("å°æ–°ä¿¡ç”¨å¡", amount, due_date, pdf_path)
    elif amount == 0: 
        print("ğŸ‰ å°æ–°é‡‘é¡ç‚º 0ï¼Œç„¡éœ€ç¹³æ¬¾ã€‚")
        move_to_trash(pdf_path)
    else: print("âŒ æ‰¾ä¸åˆ°å°æ–°é‡‘é¡")

def process_chb(pdf_path):
    filename = os.path.basename(pdf_path)
    print(f"ğŸ¤– å•Ÿå‹• [å½°åŒ–éŠ€è¡Œ] è§£ææ¨¡å¼... ({filename})")
    amount = -1
    due_date = "æœªçŸ¥æ—¥æœŸ"
    try:
        with pdfplumber.open(pdf_path, password=PASSWORDS.get("chb")) as pdf:
            text = pdf.pages[0].extract_text()
            date_match = re.search(r"æˆªæ­¢æ—¥[\s\S]{0,30}(\d{4}/\d{2}/\d{2})", text)
            if date_match: due_date = clean_date(date_match.group(1))
            else:
                all_dates = re.findall(r"(\d{4}/\d{2}/\d{2})", text)
                if all_dates: due_date = clean_date(max(all_dates))
            amt_match = re.search(r"æœ¬æœŸæ‡‰ç¹³ç¸½é¡.*?[=]\s*(\d{1,3}(?:,\d{3})*)", text, re.DOTALL)
            if not amt_match: amt_match = re.search(r"[=]\s*(\d{1,3}(?:,\d{3})*)", text)
            if amt_match: amount = int(amt_match.group(1).replace(",", ""))
    except Exception as e:
        print(f"âŒ å½°éŠ€éŒ¯èª¤ï¼š{e}")
        return
    # âœ… ä¿®æ­£åç¨±ç‚ºã€Œå½°éŠ€ä¿¡ç”¨å¡ã€
    if amount > 0: upload_to_cloud("å½°éŠ€ä¿¡ç”¨å¡", amount, due_date, pdf_path)
    else: print("âŒ æ‰¾ä¸åˆ°å½°éŠ€é‡‘é¡")

def process_cathay(pdf_path):
    filename = os.path.basename(pdf_path)
    print(f"ğŸ¤– å•Ÿå‹• [åœ‹æ³°ä¸–è¯] è§£ææ¨¡å¼... ({filename})")
    amount = -1
    due_date = "æœªçŸ¥æ—¥æœŸ"
    try:
        with pdfplumber.open(pdf_path, password=PASSWORDS.get("cathay")) as pdf:
            page = pdf.pages[0]
            words = page.extract_words()
            candidates = []
            for word in words:
                text_val = word['text']
                if "," in text_val and any(c.isdigit() for c in text_val):
                    if word['x0'] < 350: 
                        clean_val = int(text_val.replace(",", ""))
                        candidates.append(clean_val)
            if candidates: amount = max(candidates)
            full_text = page.extract_text()
            all_dates = re.findall(r"(\d{3}/\d{2}/\d{2})", full_text)
            if not all_dates: all_dates = re.findall(r"(\d{4}/\d{2}/\d{2})", full_text)
            if all_dates:
                converted_dates = [clean_date(d) for d in all_dates]
                due_date = max(converted_dates)
    except Exception as e:
        print(f"âŒ åœ‹æ³°éŒ¯èª¤ï¼š{e}")
        return
    if amount > 0: upload_to_cloud("åœ‹æ³°ä¿¡ç”¨å¡", amount, due_date, pdf_path)
    else: print("âŒ æ‰¾ä¸åˆ°åœ‹æ³°é‡‘é¡")

def process_esun(pdf_path):
    filename = os.path.basename(pdf_path)
    print(f"ğŸ¤– å•Ÿå‹• [ç‰å±±éŠ€è¡Œ] è§£ææ¨¡å¼... ({filename})")
    amount = -1
    due_date = "æœªçŸ¥æ—¥æœŸ"
    try:
        with pdfplumber.open(pdf_path, password=PASSWORDS.get("esun")) as pdf:
            text = pdf.pages[0].extract_text()
            all_dates = re.findall(r"(\d{3}/\d{2}/\d{2})", text)
            if all_dates:
                converted_dates = [clean_date(d) for d in all_dates]
                due_date = max(converted_dates)
            text_nospace = text.replace(" ", "").replace("\n", "")
            pattern = r"(\d{1,3}(?:,\d{3})*)å…ƒ(\d{1,3}(?:,\d{3})*)å…ƒ"
            matches = re.search(pattern, text_nospace)
            if matches: amount = int(matches.group(1).replace(",", ""))
            if amount == -1:
                amt_match = re.search(r"æœ¬æœŸæ‡‰ç¹³ç¸½é‡‘é¡(\d{1,3}(?:,\d{3})*)å…ƒ", text_nospace)
                if not amt_match: amt_match = re.search(r"æœ¬æœŸæ‡‰ç¹³ç¸½é‡‘é¡.*?(\d{1,3}(?:,\d{3})*)", text_nospace)
                if amt_match: amount = int(amt_match.group(1).replace(",", ""))
    except Exception as e:
        print(f"âŒ ç‰å±±éŒ¯èª¤ï¼š{e}")
        return
    if amount > 0: upload_to_cloud("ç‰å±±ä¿¡ç”¨å¡", amount, due_date, pdf_path)
    else: print("âŒ æ‰¾ä¸åˆ°ç‰å±±é‡‘é¡")

# ========= ğŸ§  ä¸»è…¦ =========
def main():
    if BIN_ID is None:
        print("âŒ è¨­å®šæª”è¼‰å…¥å¤±æ•—ï¼Œç¨‹å¼ç„¡æ³•ç¹¼çºŒã€‚")
        return

    print(f"ğŸ“‚ æ­£åœ¨æƒæè³‡æ–™å¤¾ï¼š{current_folder}")
    files = [f for f in os.listdir(current_folder) if f.lower().endswith('.pdf')]
    if not files: print("ğŸ“­ é€™è£¡æ²’æœ‰ PDF")
    
    for file in files:
        full_path = os.path.join(current_folder, file)
        
        if "æ°¸è±" in file: process_sinopac(full_path)
        elif "å¯Œé‚¦" in file: process_fubon(full_path)
        elif "TSB" in file or "å°æ–°" in file: process_taishin(full_path)
        elif "å½°åŒ–" in file or "CHB" in file: process_chb(full_path)
        elif "åœ‹æ³°" in file or "æ¶ˆè²»æ˜ç´°" in file: process_cathay(full_path)
        elif "ç‰å±±" in file or "ESUN" in file: process_esun(full_path)

if __name__ == "__main__":
    try:
        main()
    except Exception as e:
        import traceback
        print(f"\nâŒ ç™¼ç”Ÿæœªé æœŸçš„éŒ¯èª¤: {e}")
        traceback.print_exc()
    finally:
        print("\n" + "-" * 30)
        input("âœ… åŸ·è¡ŒçµæŸï¼Œè«‹æŒ‰ Enter éµé—œé–‰è¦–çª—...")
