<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>個人股票資產管理系統 v2.3.0</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-sub: #a0a0a0;
            --accent: #bb86fc;
            --danger: #cf6679;
            --success: #03dac6;
            --border: #333;
            --buy-color: #ff5252; /* 紅色代表買入/支出 */
            --sell-color: #4caf50; /* 綠色代表賣出/獲利 */
            --div-color: #ffb74d; /* 橘黃色代表股息 */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* Header & Stats */
        header {
            text-align: center;
            margin-bottom: 30px;
        }

        .total-assets {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--success);
            margin: 10px 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .stat-card {
            background-color: var(--card-bg);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-sub);
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
        }

        /* Navigation Tabs */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .tab-btn {
            background: none;
            border: none;
            color: var(--text-sub);
            padding: 10px 20px;
            font-size: 1rem;
            cursor: pointer;
            position: relative;
        }

        .tab-btn.active {
            color: var(--accent);
            font-weight: bold;
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: var(--accent);
        }

        /* Content Sections */
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }

        /* Action Bar */
        .action-bar {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 15px;
        }

        .btn {
            background-color: var(--accent);
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn:hover {
            opacity: 0.9;
        }

        /* Lists & Tables */
        .card-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .stock-card, .trans-card {
            background-color: var(--card-bg);
            padding: 15px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border);
        }

        .stock-info h3, .trans-info h3 {
            margin: 0;
            font-size: 1.1rem;
        }

        .stock-info p, .trans-info p {
            margin: 5px 0 0;
            font-size: 0.9rem;
            color: var(--text-sub);
        }

        .stock-numbers {
            text-align: right;
        }

        .price {
            font-size: 1.1rem;
            font-weight: bold;
        }

        .profit-pos { color: var(--danger); } /* 台股慣例：紅漲 */
        .profit-neg { color: var(--sell-color); } /* 台股慣例：綠跌 */
        
        /* Transaction Specific Tags */
        .tag {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-right: 5px;
            color: #fff;
        }
        .tag-buy { background-color: var(--buy-color); }
        .tag-sell { background-color: var(--sell-color); }
        .tag-div { background-color: var(--div-color); color: #000; }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            border: 1px solid var(--border);
        }

        .modal h2 {
            margin-top: 0;
            margin-bottom: 20px;
            color: var(--text-main);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-sub);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background-color: var(--bg-color);
            color: var(--text-main);
            box-sizing: border-box;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-cancel {
            background-color: transparent;
            color: var(--text-sub);
            border: 1px solid var(--border);
        }

        /* Delete Button */
        .btn-delete {
            background: none;
            border: none;
            color: var(--text-sub);
            cursor: pointer;
            margin-left: 10px;
            font-size: 1.2rem;
        }
        .btn-delete:hover {
            color: var(--danger);
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="stat-label">總資產價值 (TWD)</div>
        <div class="total-assets" id="totalAssets">0</div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">總成本</div>
                <div class="stat-value" id="totalCost">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">未實現損益</div>
                <div class="stat-value" id="unrealizedPL">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">已實現/股息</div>
                <div class="stat-value" id="realizedPL" style="color: var(--div-color);">0</div>
            </div>
        </div>
    </header>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('portfolio')">持股庫存</button>
        <button class="tab-btn" onclick="switchTab('transactions')">交易紀錄</button>
    </div>

    <div id="portfolio" class="section active">
        <div class="action-bar">
            <button class="btn" onclick="openModal('stock')">+ 新增持股</button>
        </div>
        <div id="stockList" class="card-list">
            </div>
    </div>

    <div id="transactions" class="section">
        <div class="action-bar">
            <button class="btn" onclick="openModal('transaction')">+ 新增紀錄</button>
        </div>
        <div id="transList" class="card-list">
            </div>
    </div>
</div>

<div id="stockModal" class="modal">
    <div class="modal-content">
        <h2>新增/編輯 持股</h2>
        <form id="stockForm">
            <input type="hidden" id="editIndex" value="-1">
            <div class="form-group">
                <label>股票名稱/代號</label>
                <input type="text" id="stockName" required placeholder="例如：2330 台積電">
            </div>
            <div class="form-group">
                <label>目前市價</label>
                <input type="number" id="currentPrice" step="0.01" required>
            </div>
            <div class="form-group">
                <label>持有股數</label>
                <input type="number" id="shares" required>
            </div>
            <div class="form-group">
                <label>平均成本</label>
                <input type="number" id="avgCost" step="0.01" required>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-cancel" onclick="closeModal('stock')">取消</button>
                <button type="submit" class="btn">儲存</button>
            </div>
        </form>
    </div>
</div>

<div id="transModal" class="modal">
    <div class="modal-content">
        <h2>新增交易紀錄</h2>
        <form id="transForm">
            <div class="form-group">
                <label>日期</label>
                <input type="date" id="transDate" required>
            </div>
            <div class="form-group">
                <label>交易類別</label>
                <select id="transType" onchange="toggleTransFields()" required>
                    <option value="buy">買入</option>
                    <option value="sell">賣出</option>
                    <option value="dividend">領息</option>
                </select>
            </div>
            <div class="form-group">
                <label>股票名稱/代號</label>
                <input type="text" id="transName" required placeholder="例如：0050">
            </div>
            <div class="form-group" id="priceGroup">
                <label>成交價格/單價</label>
                <input type="number" id="transPrice" step="0.01">
            </div>
            <div class="form-group" id="sharesGroup">
                <label>交易股數</label>
                <input type="number" id="transShares">
            </div>
            <div class="form-group" id="amountGroup">
                <label>總金額 (含手續費/股息總額)</label>
                <input type="number" id="transTotal" required>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-cancel" onclick="closeModal('transaction')">取消</button>
                <button type="submit" class="btn">儲存</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Data Storage
    let portfolio = JSON.parse(localStorage.getItem('myPortfolio_v2')) || [];
    let transactions = JSON.parse(localStorage.getItem('myTransactions_v2')) || [];

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        renderPortfolio();
        renderTransactions();
        updateStats();
        // Set default date to today
        document.getElementById('transDate').valueAsDate = new Date();
    });

    // --- Core Logic ---

    function saveData() {
        localStorage.setItem('myPortfolio_v2', JSON.stringify(portfolio));
        localStorage.setItem('myTransactions_v2', JSON.stringify(transactions));
        renderPortfolio();
        renderTransactions();
        updateStats();
    }

    function updateStats() {
        let totalVal = 0;
        let totalCost = 0;
        
        // Portfolio Stats
        portfolio.forEach(stock => {
            totalVal += stock.price * stock.shares;
            totalCost += stock.cost * stock.shares;
        });

        const unrealized = totalVal - totalCost;
        
        // Calculate Realized PL + Dividends from Transactions
        let realized = 0;
        transactions.forEach(t => {
            if (t.type === 'dividend') {
                realized += parseFloat(t.total);
            } else if (t.type === 'sell') {
                // Here we simplify: User inputs Total Amount for sell. 
                // To calculate strict realized P/L requires FIFO logic which is complex.
                // For this version, we act as a log. Or we can ask user to input "Profit".
                // Let's assume the user puts the "Net Amount" received.
                // Without knowing the cost basis of the specific sold lot, exact realized P/L is hard.
                // For v2.3.0, we will track Dividends primarily in this stats box.
            }
        });

        // Update DOM
        document.getElementById('totalAssets').textContent = formatCurrency(totalVal);
        document.getElementById('totalCost').textContent = formatCurrency(totalCost);
        
        const unEl = document.getElementById('unrealizedPL');
        unEl.textContent = (unrealized > 0 ? "+" : "") + formatCurrency(unrealized);
        unEl.className = "stat-value " + (unrealized >= 0 ? "profit-pos" : "profit-neg");

        document.getElementById('realizedPL').textContent = formatCurrency(realized);
    }

    // --- Rendering ---

    function renderPortfolio() {
        const list = document.getElementById('stockList');
        list.innerHTML = '';
        
        if (portfolio.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:var(--text-sub); padding:20px;">尚無持股，請點擊上方按鈕新增。</div>';
            return;
        }

        portfolio.forEach((stock, index) => {
            const marketVal = stock.price * stock.shares;
            const costVal = stock.cost * stock.shares;
            const pl = marketVal - costVal;
            const plClass = pl >= 0 ? 'profit-pos' : 'profit-neg';
            const plPercent = ((pl / costVal) * 100).toFixed(2);

            const item = document.createElement('div');
            item.className = 'stock-card';
            item.onclick = (e) => { if(e.target.className !== 'btn-delete') editStock(index); };
            item.innerHTML = `
                <div class="stock-info">
                    <h3>${stock.name}</h3>
                    <p>${stock.shares} 股 • 均價 ${stock.cost}</p>
                </div>
                <div class="stock-numbers">
                    <div class="price">${formatCurrency(marketVal)}</div>
                    <div style="font-size: 0.9rem;" class="${plClass}">
                        ${pl > 0 ? '+' : ''}${formatCurrency(pl)} (${plPercent}%)
                    </div>
                </div>
                <button class="btn-delete" onclick="deleteStock(${index}, event)">×</button>
            `;
            list.appendChild(item);
        });
    }

    function renderTransactions() {
        const list = document.getElementById('transList');
        list.innerHTML = '';
        
        // Sort by date desc
        const sortedTrans = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date));

        if (sortedTrans.length === 0) {
            list.innerHTML = '<div style="text-align:center; color:var(--text-sub); padding:20px;">尚無交易紀錄。</div>';
            return;
        }

        sortedTrans.forEach((t, index) => {
            let tagClass = '';
            let typeLabel = '';
            let amountSign = '';
            
            switch(t.type) {
                case 'buy': tagClass = 'tag-buy'; typeLabel = '買入'; amountSign = '-'; break;
                case 'sell': tagClass = 'tag-sell'; typeLabel = '賣出'; amountSign = '+'; break;
                case 'dividend': tagClass = 'tag-div'; typeLabel = '領息'; amountSign = '+'; break;
            }

            // Real index in original array needs to be found if we want to delete, 
            // but for simplicity we'll just filter valid ones or reload.
            // Using a simple workaround: Store timestamp ID in future versions.
            
            const item = document.createElement('div');
            item.className = 'trans-card';
            item.innerHTML = `
                <div class="trans-info">
                    <h3><span class="tag ${tagClass}">${typeLabel}</span> ${t.name}</h3>
                    <p>${t.date} ${t.type !== 'dividend' ? '• ' + t.shares + '股 @ ' + t.price : ''}</p>
                </div>
                <div class="stock-numbers">
                    <div class="price" style="color: ${t.type === 'buy' ? 'var(--text-main)' : (t.type === 'dividend' ? 'var(--div-color)' : 'var(--success)')}">
                        ${amountSign}${formatCurrency(t.total)}
                    </div>
                </div>
                 <button class="btn-delete" onclick="deleteTransaction(${transactions.indexOf(t)})">×</button>
            `;
            list.appendChild(item);
        });
    }

    // --- Form Handling ---

    const stockForm = document.getElementById('stockForm');
    stockForm.onsubmit = (e) => {
        e.preventDefault();
        const index = document.getElementById('editIndex').value;
        const data = {
            name: document.getElementById('stockName').value,
            price: parseFloat(document.getElementById('currentPrice').value),
            shares: parseInt(document.getElementById('shares').value),
            cost: parseFloat(document.getElementById('avgCost').value)
        };

        if (index === "-1") {
            portfolio.push(data);
        } else {
            portfolio[index] = data;
        }
        
        closeModal('stock');
        saveData();
    };

    const transForm = document.getElementById('transForm');
    transForm.onsubmit = (e) => {
        e.preventDefault();
        const data = {
            date: document.getElementById('transDate').value,
            type: document.getElementById('transType').value,
            name: document.getElementById('transName').value,
            price: parseFloat(document.getElementById('transPrice').value) || 0,
            shares: parseInt(document.getElementById('transShares').value) || 0,
            total: parseFloat(document.getElementById('transTotal').value)
        };
        
        transactions.push(data);
        closeModal('transaction');
        saveData();
    };

    // --- Helpers ---

    function switchTab(tabName) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        
        document.getElementById(tabName).classList.add('active');
        // Find button that called this (rough match)
        event.target.classList.add('active');
    }

    function openModal(type) {
        if (type === 'stock') {
            document.getElementById('stockForm').reset();
            document.getElementById('editIndex').value = "-1";
            document.getElementById('stockModal').style.display = 'flex';
        } else {
            document.getElementById('transForm').reset();
            document.getElementById('transDate').valueAsDate = new Date();
            toggleTransFields(); // reset visibility
            document.getElementById('transModal').style.display = 'flex';
        }
    }

    function closeModal(type) {
        document.getElementById(type + 'Modal').style.display = 'none';
    }

    function editStock(index) {
        const stock = portfolio[index];
        document.getElementById('stockName').value = stock.name;
        document.getElementById('currentPrice').value = stock.price;
        document.getElementById('shares').value = stock.shares;
        document.getElementById('avgCost').value = stock.cost;
        document.getElementById('editIndex').value = index;
        document.getElementById('stockModal').style.display = 'flex';
    }

    function deleteStock(index, e) {
        e.stopPropagation(); // prevent edit trigger
        if(confirm('確定要刪除此持股嗎？')) {
            portfolio.splice(index, 1);
            saveData();
        }
    }

    function deleteTransaction(index) {
        if(confirm('確定要刪除此紀錄嗎？')) {
            transactions.splice(index, 1);
            saveData();
        }
    }

    function toggleTransFields() {
        const type = document.getElementById('transType').value;
        const priceGroup = document.getElementById('priceGroup');
        const sharesGroup = document.getElementById('sharesGroup');
        
        if (type === 'dividend') {
            priceGroup.style.display = 'none';
            sharesGroup.style.display = 'none';
        } else {
            priceGroup.style.display = 'block';
            sharesGroup.style.display = 'block';
        }
    }

    function formatCurrency(num) {
        return new Intl.NumberFormat('zh-TW', { maximumFractionDigits: 0 }).format(num);
    }

    // Auto calculate total in transaction form
    document.getElementById('transPrice').addEventListener('input', calcTransTotal);
    document.getElementById('transShares').addEventListener('input', calcTransTotal);

    function calcTransTotal() {
        const p = parseFloat(document.getElementById('transPrice').value) || 0;
        const s = parseFloat(document.getElementById('transShares').value) || 0;
        if (p && s) {
            document.getElementById('transTotal').value = Math.floor(p * s);
        }
    }

</script>

</body>
</html>
