<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    <title>å¡ç‰‡ç®¡å®¶ Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background-color: #f4f6f9; font-family: -apple-system, "Microsoft JhengHei", sans-serif; padding-bottom: 80px; user-select: none; -webkit-user-select: none; }
        .card-custom { border: none; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        /* é ‚éƒ¨ç¸½è¦½å€ */
        .total-box { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            border-radius: 0 0 25px 25px; 
            margin-top: -25px; 
            padding-top: 50px !important; 
            padding-bottom: 20px !important;
        }

        /* ç‹€æ…‹æ¨™ç±¤ */
        .status-urgent { background-color: #ffebee; color: #c62828; font-weight: bold; }
        .status-paid { text-decoration: line-through; color: #999; }
        
        /* åº•éƒ¨å°èˆª */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; border-top: 1px solid #eee;
            display: flex; justify-content: space-around; padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 1000;
        }
        .nav-item { text-align: center; color: #999; font-size: 0.8rem; cursor: pointer; flex: 1;}
        .nav-item.active { color: #667eea; font-weight: bold; }
        .nav-item i { font-size: 1.2rem; display: block; margin-bottom: 4px; }

        /* é é¢åˆ‡æ› */
        .page-section { display: none; }
        .page-section.active { display: block; }

        .btn-circle { border-radius: 50%; width: 40px; height: 40px; padding: 0; display: inline-flex; justify-content: center; align-items: center;}
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 9999;
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="spinner-border text-primary" role="status"></div>
    <div class="mt-3 fw-bold text-primary">åŒæ­¥ä¸­...</div>
</div>

<div id="page-dashboard" class="page-section active">
    <div class="card card-custom total-box mb-3 p-4 text-center shadow">
        <div class="d-flex justify-content-between align-items-start w-100 mb-2">
            <span class="opacity-50 small"><i class="fas fa-signal"></i> Proç‰ˆ</span>
            <button class="btn btn-sm btn-outline-light border-0" onclick="syncData('download')"><i class="fas fa-sync-alt"></i></button>
        </div>
        <h6 class="opacity-75 text-uppercase ls-1">æœ¬æœˆå¾…ç¹³ç¸½é¡</h6>
        <h1 class="display-3 fw-bold my-2" id="displayTotal">$0</h1>
        
        <div class="mt-3 d-flex justify-content-center gap-2">
            <button class="btn btn-light text-primary btn-sm px-3 shadow-sm" onclick="syncData('upload')">
                <i class="fas fa-cloud-upload-alt"></i> å­˜æª”
            </button>
            <button class="btn btn-outline-light btn-sm px-3" onclick="exportToExcel()">
                <i class="fas fa-file-excel"></i> åŒ¯å‡º
            </button>
        </div>
    </div>

    <div class="container" style="max-width: 800px;">
        <div id="statementAlerts"></div>

        <div class="d-flex justify-content-between align-items-center mb-2 px-2">
            <h6 class="fw-bold text-muted mb-0">å¾…ç¹³å¸³å–®</h6>
            <button class="btn btn-sm text-primary" onclick="showAddModal()"><i class="fas fa-plus"></i> æ‰‹å‹•æ–°å¢</button>
        </div>

        <div class="card card-custom mb-5">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <tbody id="unpaidList"></tbody>
                    </table>
                </div>
                <div id="emptyMsg" class="text-center py-5 text-muted" style="display:none;">
                    <i class="fas fa-check-circle fa-3x mb-3 text-success opacity-50"></i>
                    <p>å¤ªæ£’äº†ï¼ç›®å‰æ²’æœ‰å¾…ç¹³å¸³å–®</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="page-history" class="page-section">
    <div class="container pt-4" style="max-width: 800px;">
        <h5 class="fw-bold mb-3 px-2"><i class="fas fa-history text-primary"></i> ç¹³æ¬¾æ­·å²ç´€éŒ„</h5>
        <div class="card card-custom">
            <div class="card-body p-0">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light small">
                        <tr>
                            <th class="ps-3">å¡ç‰‡</th>
                            <th>é‡‘é¡</th>
                            <th>æœŸé™</th>
                            <th class="text-end pe-3">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="paidList"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="page-settings" class="page-section">
    <div class="container pt-4" style="max-width: 800px;">
        <h5 class="fw-bold mb-3 px-2"><i class="fas fa-cog text-primary"></i> è¨­å®šèˆ‡å‡ºå¸³æ—¥æé†’</h5>
        
        <div class="card card-custom mb-4">
            <div class="card-body">
                <h6 class="fw-bold mb-3">â˜ï¸ JSONBin é›²ç«¯åŒæ­¥</h6>
                <div class="mb-2">
                    <label class="small text-muted">Bin ID</label>
                    <input type="text" class="form-control bg-light" id="inputBinId">
                </div>
                <div class="mb-3">
                    <label class="small text-muted">API Key</label>
                    <input type="password" class="form-control bg-light" id="inputApiKey">
                </div>
                <button class="btn btn-primary w-100" onclick="saveKeys()">å„²å­˜é‡‘é‘°</button>
            </div>
        </div>

        <div class="card card-custom mb-4">
            <div class="card-body">
                <h6 class="fw-bold mb-3">ğŸ“… æ–°å¢å¡ç‰‡å‡ºå¸³æé†’</h6>
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="newCardName" placeholder="å¡ç‰‡åç¨± (å¦‚: ç‰å±±)">
                    <input type="number" class="form-control" id="newCardDay" placeholder="å‡ºå¸³æ—¥ (å¦‚: 13)" style="max-width: 80px;">
                    <button class="btn btn-outline-primary" onclick="addCardSetting()">æ–°å¢</button>
                </div>
                
                <ul class="list-group list-group-flush" id="cardSettingsList">
                    </ul>
            </div>
        </div>
    </div>
</div>

<div class="bottom-nav">
    <div class="nav-item active" onclick="switchPage('dashboard')">
        <i class="fas fa-wallet"></i> å¾…ç¹³å¸³å–®
    </div>
    <div class="nav-item" onclick="switchPage('history')">
        <i class="fas fa-history"></i> æ­·å²ç´€éŒ„
    </div>
    <div class="nav-item" onclick="switchPage('settings')">
        <i class="fas fa-sliders-h"></i> è¨­å®š
    </div>
</div>

<div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æ–°å¢å¸³å–®</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addForm">
                    <input type="text" class="form-control mb-2" id="addName" placeholder="å¡ç‰‡åç¨±" required>
                    <input type="number" class="form-control mb-2" id="addAmount" placeholder="é‡‘é¡" required>
                    <label class="small text-muted">æˆªæ­¢æ—¥</label>
                    <input type="date" class="form-control mb-3" id="addDate" required>
                    <button type="submit" class="btn btn-primary w-100">ç¢ºå®šæ–°å¢</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // è³‡æ–™çµæ§‹
    let data = {
        bills: [],
        cards: [] // å„²å­˜ {name: "ç‰å±±", day: 13}
    };

    // åˆå§‹åŒ–
    let binId = localStorage.getItem('jsonbin_bin_id') || '';
    let apiKey = localStorage.getItem('jsonbin_api_key') || '';
    
    // UI åƒè€ƒ
    const addModal = new bootstrap.Modal(document.getElementById('addModal'));
    const loadingOverlay = document.getElementById('loadingOverlay');

    // å•Ÿå‹•
    loadLocal();
    document.getElementById('inputBinId').value = binId;
    document.getElementById('inputApiKey').value = apiKey;
    document.getElementById('addDate').value = new Date().toISOString().split('T')[0];

    // --- æ ¸å¿ƒé‚è¼¯ ---

    function switchPage(pageName) {
        document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
        document.getElementById('page-' + pageName).classList.add('active');
        
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }

    function render() {
        const unpaidList = document.getElementById('unpaidList');
        const paidList = document.getElementById('paidList');
        const emptyMsg = document.getElementById('emptyMsg');
        
        unpaidList.innerHTML = '';
        paidList.innerHTML = '';
        
        let totalAmount = 0;
        let hasUnpaid = false;

        // æ’åºï¼šæœªç¹³ä¾æ—¥æœŸè¿‘->é ï¼Œå·²ç¹³ä¾æ—¥æœŸé ->è¿‘
        const unpaidBills = data.bills.filter(b => b.status !== 'paid').sort((a,b) => new Date(a.date) - new Date(b.date));
        const paidBills = data.bills.filter(b => b.status === 'paid').sort((a,b) => new Date(b.date) - new Date(a.date));

        // æ¸²æŸ“æœªç¹³
        unpaidBills.forEach(bill => {
            hasUnpaid = true;
            totalAmount += bill.amount;
            const diffDays = Math.ceil((new Date(bill.date) - new Date().setHours(0,0,0,0)) / (86400000));
            
            let badge = diffDays < 0 ? `<span class="badge bg-danger">éæœŸ</span>` : 
                        diffDays <= 3 ? `<span class="badge bg-warning text-dark">å‰© ${diffDays} å¤©</span>` : 
                        `<span class="badge bg-light text-dark border">å‰© ${diffDays} å¤©</span>`;

            unpaidList.innerHTML += `
                <tr>
                    <td class="ps-3 fw-bold">${bill.name}</td>
                    <td>$${bill.amount.toLocaleString()}</td>
                    <td><small class="text-muted">${bill.date.slice(5)}</small><br>${badge}</td>
                    <td class="text-end pe-3">
                        <button onclick="markAsPaid(${bill.id})" class="btn btn-outline-success btn-sm btn-circle"><i class="fas fa-check"></i></button>
                    </td>
                </tr>`;
        });

        // æ¸²æŸ“å·²ç¹³
        paidBills.forEach(bill => {
            paidList.innerHTML += `
                <tr class="status-paid">
                    <td class="ps-3">${bill.name}</td>
                    <td>$${bill.amount.toLocaleString()}</td>
                    <td>${bill.date}</td>
                    <td class="text-end pe-3">
                        <button onclick="deleteBill(${bill.id})" class="btn btn-light text-danger btn-sm"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
        });

        // ç‹€æ…‹é¡¯ç¤º
        document.getElementById('displayTotal').textContent = '$' + totalAmount.toLocaleString();
        emptyMsg.style.display = hasUnpaid ? 'none' : 'block';

        // æª¢æŸ¥å‡ºå¸³æ—¥æé†’
        checkStatementAlerts();
        renderCardSettings();
    }

    // --- æé†’åŠŸèƒ½ ---
    function checkStatementAlerts() {
        const alertBox = document.getElementById('statementAlerts');
        alertBox.innerHTML = '';
        const today = new Date();
        const currentDay = today.getDate();
        
        // æ‰¾å‡ºæœ¬æœˆå·²æœ‰çš„å¸³å–® (æ ¹æ“š ID æ™‚é–“æˆ³è¨˜ï¼Œç°¡å–®åˆ¤æ–·æ˜¯å¦ç‚ºè¿‘æœŸ)
        // æ›´å¥½çš„æ–¹å¼æ˜¯çœ‹ created_atï¼Œç›®å‰ç°¡åŒ–ï¼šåªè¦åˆ—è¡¨è£¡æœ‰é€™å€‹åå­—ä¸”æœªç¹³ï¼Œå°±ç•¶ä½œæœ‰æ”¶åˆ°
        
        data.cards.forEach(card => {
            // å¦‚æœä»Šå¤©å·²ç¶“è¶…éé è¨­å‡ºå¸³æ—¥
            if (currentDay >= card.day) {
                // æª¢æŸ¥æ˜¯å¦å·²æ”¶åˆ°å¸³å–® (æœªç¹³åˆ—è¡¨ä¸­æ˜¯å¦æœ‰è©²å¡ç‰‡)
                const hasBill = data.bills.some(b => b.name.includes(card.name) && b.status !== 'paid');
                
                if (!hasBill) {
                    alertBox.innerHTML += `
                        <div class="alert alert-warning border-0 shadow-sm d-flex align-items-center" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <div>
                                <strong>${card.name}</strong> æ‡‰è©²åœ¨ ${card.day} è™Ÿå‡ºå¸³ï¼Œä½†é‚„æ²’çœ‹åˆ°å¸³å–®å–”ï¼
                            </div>
                        </div>`;
                }
            }
        });
    }

    // --- è³‡æ–™æ“ä½œ ---
    function markAsPaid(id) {
        if(confirm('ç¢ºèªå·²ç¹³æ¬¾å®Œæˆï¼Ÿ')) {
            const bill = data.bills.find(b => b.id === id);
            if(bill) { 
                bill.status = 'paid'; // æ”¹ç‹€æ…‹ï¼Œä¸åˆªé™¤
                saveLocal();
                render();
            }
        }
    }

    function deleteBill(id) {
        if(confirm('ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ­¤ç´€éŒ„å—ï¼Ÿ')) {
            data.bills = data.bills.filter(b => b.id !== id);
            saveLocal();
            render();
        }
    }

    function addCardSetting() {
        const name = document.getElementById('newCardName').value;
        const day = parseInt(document.getElementById('newCardDay').value);
        if(name && day) {
            data.cards.push({name, day});
            saveLocal();
            render();
            document.getElementById('newCardName').value = '';
            document.getElementById('newCardDay').value = '';
        }
    }

    function removeCardSetting(idx) {
        data.cards.splice(idx, 1);
        saveLocal();
        render();
    }

    function renderCardSettings() {
        const list = document.getElementById('cardSettingsList');
        list.innerHTML = '';
        (data.cards || []).forEach((c, idx) => {
            list.innerHTML += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>${c.name} (æ¯æœˆ ${c.day} è™Ÿ)</span>
                    <button class="btn btn-sm text-danger" onclick="removeCardSetting(${idx})"><i class="fas fa-times"></i></button>
                </li>`;
        });
    }

    // --- å„²å­˜èˆ‡åŒæ­¥ ---
    function saveLocal() {
        localStorage.setItem('myCreditData', JSON.stringify(data));
    }

    function loadLocal() {
        const stored = localStorage.getItem('myCreditData');
        if (stored) {
            data = JSON.parse(stored);
            // å…¼å®¹èˆŠè³‡æ–™ (å¦‚æœ bills æ˜¯ç´”é™£åˆ—)
            if (Array.isArray(data)) data = { bills: data, cards: [] };
            if (!data.cards) data.cards = [];
        }
        render();
    }

    function saveKeys() {
        binId = document.getElementById('inputBinId').value.trim();
        apiKey = document.getElementById('inputApiKey').value.trim();
        localStorage.setItem('jsonbin_bin_id', binId);
        localStorage.setItem('jsonbin_api_key', apiKey);
        alert('é‡‘é‘°å·²å„²å­˜ï¼');
    }

    async function syncData(mode) {
        if (!binId || !apiKey) return alert('è«‹å…ˆåˆ°è¨­å®šé è¼¸å…¥é‡‘é‘°');
        loadingOverlay.style.display = 'flex';
        const url = `https://api.jsonbin.io/v3/b/${binId}`;
        
        try {
            if (mode === 'download') {
                const res = await fetch(url + '/latest', { headers: { 'X-Master-Key': apiKey } });
                if (!res.ok) throw new Error('ä¸‹è¼‰å¤±æ•—');
                const json = await res.json();
                // ç¢ºä¿æ ¼å¼æ­£ç¢º
                let cloudData = json.record;
                if (Array.isArray(cloudData)) cloudData = { bills: cloudData, cards: [] };
                
                data = cloudData;
                saveLocal();
                alert('åŒæ­¥å®Œæˆï¼');
            } else {
                const res = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': apiKey },
                    body: JSON.stringify(data)
                });
                if (!res.ok) throw new Error('ä¸Šå‚³å¤±æ•—');
                alert('å·²å‚™ä»½åˆ°é›²ç«¯ï¼');
            }
        } catch (e) {
            alert(e.message);
        } finally {
            loadingOverlay.style.display = 'none';
            render();
        }
    }

    // æ‰‹å‹•æ–°å¢è¡¨å–®
    function showAddModal() { addModal.show(); }
    document.getElementById('addForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const newBill = {
            id: Date.now(),
            name: document.getElementById('addName').value,
            amount: parseInt(document.getElementById('addAmount').value),
            date: document.getElementById('addDate').value,
            status: 'unpaid'
        };
        data.bills.push(newBill);
        saveLocal();
        render();
        addModal.hide();
        this.reset();
    });

    // åŒ¯å‡º Excel
    function exportToExcel() {
        if (data.bills.length === 0) return alert("æ²’è³‡æ–™å¯åŒ¯å‡º");
        let csv = "å¡ç‰‡åç¨±,é‡‘é¡,æˆªæ­¢æ—¥,ç‹€æ…‹\n";
        data.bills.forEach(b => {
            const status = b.status === 'paid' ? 'å·²ç¹³' : 'æœªç¹³';
            csv += `"${b.name}",${b.amount},${b.date},${status}\n`;
        });
        const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `å¸³å–®å‚™ä»½_${new Date().toISOString().slice(0,10)}.csv`;
        link.click();
    }
</script>
</body>
</html>